[
    {
        "id": "f1e965419e59229c",
        "type": "tab",
        "label": "Intuis connect - modèle",
        "disabled": false,
        "info": "Créé par Yann V. le 03/07/2024\nDernière mise a jour le 17/10/2024",
        "env": []
    },
    {
        "id": "e9fafc919bcb1bb0",
        "type": "tab",
        "label": "Récup Stats Conso",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "860dc5f127961a85",
        "type": "tab",
        "label": "Pilotage d'un radiateur",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a9b5c4b52d4c4353",
        "type": "tab",
        "label": "PIlotage Maison",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "01517d737b12772c",
        "type": "tab",
        "label": "Choix Planning",
        "disabled": false,
        "info": "Créé par Yann V. le 26/10/2024\r\nDernière mise a jour le 26/10/2024",
        "env": []
    },
    {
        "id": "8c2a949c276d4083",
        "type": "tab",
        "label": "Modification Planning",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8322e2d81f057f60",
        "type": "tab",
        "label": "Pour Import Stats",
        "disabled": false,
        "locked": true,
        "info": "",
        "env": []
    },
    {
        "id": "c8fb396ecc5efcfc",
        "type": "tab",
        "label": "Ancien Flux Consos",
        "disabled": false,
        "locked": true,
        "info": "",
        "env": []
    },
    {
        "id": "3a74ec19e4fe846e",
        "type": "tab",
        "label": "Flux 3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8a1b9db73a84d263",
        "type": "group",
        "z": "f1e965419e59229c",
        "name": "Connexion préliminaire et récupération du token",
        "style": {
            "label": true
        },
        "nodes": [
            "0537953a8c433072",
            "6d8913e4536301d8",
            "2b4ba9f422939106",
            "f7bb99e9e94723f5",
            "f9016440fc664e26",
            "8fd2293bce221f2b",
            "8d364c1971adf29a",
            "b5a35aa53e77a471",
            "4de2743da191dfa8",
            "b0043aa88865992c",
            "972e79dedee2a59f",
            "ed7f64c8e43f05fd",
            "911cb284365dd376"
        ],
        "x": 54,
        "y": 19,
        "w": 1617,
        "h": 322
    },
    {
        "id": "d73b70410efb22bb",
        "type": "group",
        "z": "860dc5f127961a85",
        "name": "Passer une commande manuelle",
        "style": {
            "label": true
        },
        "nodes": [
            "2284f3734545b917",
            "291def603d112901",
            "8dbef555eed4361a",
            "2dce5e6356438427",
            "6d5d3571be5633fd",
            "7af3acb374f2f8df",
            "c69b09baaa192488",
            "016343b39a2a28ab",
            "8e6f7b77b1eb54af",
            "ec71b21f5bc9c093",
            "eba27c296525a892",
            "6af3d466047f7a52",
            "a29b863ea3041d60",
            "5c8f4bcc2837e168",
            "b768431bdc70ed26",
            "98cc6cd141f417dd",
            "d8231a77695dcab3",
            "aa78272c808be164",
            "7fa446ca2816755a"
        ],
        "x": 14,
        "y": 159,
        "w": 1832,
        "h": 362
    },
    {
        "id": "584780eef1d73b39",
        "type": "group",
        "z": "a9b5c4b52d4c4353",
        "name": "Passer une commande manuelle",
        "style": {
            "label": true
        },
        "nodes": [
            "70dd93a666dabb85",
            "a020d0b832de0461",
            "b370c200d67c72d0",
            "694eff9388e6ee0b",
            "f401417910df9539",
            "eb25f09353fdc7d3",
            "93940e1bce67c556",
            "a28d9e95cda9fb75",
            "137a2efc6997b839",
            "af254d5733c8ef04",
            "26a1b2a7070080d1",
            "8046e791812a85ff",
            "631269ebe3e11f3c",
            "a5251ee538ed1710",
            "0b868dcf7fcf7799",
            "eb93568756aae0c1",
            "20f1c4335ef651b8"
        ],
        "x": 14,
        "y": 39,
        "w": 2052,
        "h": 202
    },
    {
        "id": "f6858dc60a10d52d",
        "type": "group",
        "z": "01517d737b12772c",
        "name": "Aqcuitter ouverture fenêtre",
        "style": {
            "label": true
        },
        "nodes": [
            "db2e9700612e90c7",
            "ac8b2b7fd8f8338b",
            "305e6eecdfcdbab8",
            "bf7f6839c6704e59",
            "39764885d59f717f",
            "2659be5f29a72d6f",
            "d557fa56bfd86784",
            "5f2c7142749b5d0a",
            "7e4ede2a32fcc1c8"
        ],
        "x": 34,
        "y": 319,
        "w": 1432,
        "h": 202
    },
    {
        "id": "82fdc54c029e354a",
        "type": "group",
        "z": "f1e965419e59229c",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "fc9f530b0715cf8a",
            "38f2e338ee2f0c53",
            "10ec6696ed8ffdbc",
            "ef41488370a3da7c",
            "c89cd37deb502b6e",
            "246e8b3fbb94966b",
            "da032647e8394bc7",
            "177ef5b440ff3b10",
            "320438fe15437990",
            "cac1072fd05e3978",
            "475273f619e07148",
            "825482ae8054ded6",
            "8157172cb4371bda",
            "4164cee609b6fbc9",
            "d8b5d25dc8eccd40",
            "c87790293566b3ed",
            "4463d66b0b811553",
            "f1bb973db6a7419f",
            "9aaf59788fe975dc",
            "ae9ae3d6db70bc10",
            "2b0d045fe7e68469",
            "64f2ab526f716e35",
            "2a725d9e7481226e",
            "d17f38f0345c4336",
            "dba0015b978cd3bf",
            "e01ac648b59502d4",
            "8c3753d388c2d13f",
            "b8dffacf14b14977",
            "6884f996857e6917",
            "ba9e7bf44175a4f4",
            "f84f472d6afd7403",
            "fd645b38f6867145",
            "290e5aa38a39cf3c",
            "03775eeb0b6cec66",
            "2001a6a15d431f52",
            "22eea655998ce461",
            "6ac47d41f757a042",
            "7f8709104a52bcd0",
            "18525a6ce7300a2d",
            "d96ba9496e94456c",
            "fb71b92c165d2e58",
            "06841b92d489b72f",
            "2fef7d661e1314b8",
            "125e2b3f0c624ce1",
            "0cd8258c7408be65",
            "abf4faf2e79038ed",
            "4775b98450107acc",
            "8b0461d8f10574db",
            "0764c479ea31db19",
            "1abff91bfa3d21b1",
            "034326fe1359a1f8",
            "1eb6909e3b3c5cb8",
            "ab4254c1c0fcd9b7",
            "1849db0f5f28349b",
            "bba581a115bc3210",
            "b2d4fda8d59af55d",
            "7f6d47927e4b0f0d"
        ],
        "x": 514,
        "y": 939,
        "w": 2332,
        "h": 742
    },
    {
        "id": "a8c552048ea1aa6a",
        "type": "group",
        "z": "01517d737b12772c",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "71d1d1dbf7e5a846",
            "3e7607f0ba55c20c",
            "970fe3350a767473",
            "17f16f38597c8169",
            "65fc4c1d577cc47b"
        ],
        "x": 34,
        "y": 119,
        "w": 1232,
        "h": 82
    },
    {
        "id": "664426c7483c1246",
        "type": "group",
        "z": "8322e2d81f057f60",
        "name": "Import-HA — Fichier unique DAILY (90 j, finit J-5) + base offset",
        "style": {
            "label": true
        },
        "nodes": [
            "de739397b5b2dbaa",
            "383fb030d0a0c1b8",
            "e42b9ca63874ea93",
            "6af3eda862574d9e",
            "f4d07f1088ee6ff9",
            "89ea31c75aac3ae0",
            "7798508a88419ba7",
            "02f6d7f621a64af3",
            "25869d436d13e5b0"
        ],
        "x": 54,
        "y": 19,
        "w": 1662,
        "h": 222
    },
    {
        "id": "8966036e727ee1b2",
        "type": "group",
        "z": "8322e2d81f057f60",
        "name": "Export CSV Import-HA — 4 jours (hourly → fichier unique)",
        "style": {
            "label": true
        },
        "nodes": [
            "f5f0d60ec8534881",
            "d741fa5a11b6cc58",
            "6c9b85290160a68a",
            "c004314fe09dbb61",
            "e871efe62d94e232",
            "09afbedac84a3b08",
            "7b446a7479a157d9",
            "286119c2c9222470",
            "09048c6352824c6f",
            "9fb7d89f8e79dc26",
            "c9ed7a35aeacd5ee"
        ],
        "x": 54,
        "y": 299,
        "w": 1792,
        "h": 262
    },
    {
        "id": "71dbb83f1cd1e302",
        "type": "group",
        "z": "8322e2d81f057f60",
        "name": "Pour rebas de Base_kWh",
        "style": {
            "label": true
        },
        "nodes": [
            "4d408e1ee1df8619",
            "601b073a9f5699f4",
            "7e016e08c43d0df3"
        ],
        "x": 74,
        "y": 699,
        "w": 872,
        "h": 82
    },
    {
        "id": "84c133862c6ab1a2",
        "type": "group",
        "z": "c8fb396ecc5efcfc",
        "name": "Récupération consommations ",
        "style": {
            "label": true
        },
        "nodes": [
            "a4cc152feb07a94d",
            "b6b5460f08d34b31",
            "2710c1f1040d343c",
            "fa6103c020074676",
            "123754ca51635627",
            "b2878673f4d5558f",
            "505894bb1a05220a",
            "338911d72efbbe8c",
            "b4a36816213b7b3b",
            "5167574474aa85ad",
            "a262f752091ad391",
            "1367850bf3537e88",
            "4e44207618b4aa90",
            "9b2b8ba1453c18c6",
            "1dcdb6e47dd52c38",
            "7ced2ac927d6ddfd",
            "22440edd3cd5e1e8",
            "437c3dcac27ed8ca",
            "355d9660ad39ed64",
            "e8645fa04460607f",
            "3da322fc6ede92bd",
            "f4dd2e98edd78e6e",
            "0587fb740ba0c6e2",
            "c862b6e600f79faf",
            "f31753e734587037",
            "a12369b4d0ccaa7b"
        ],
        "x": 8,
        "y": 59,
        "w": 1978,
        "h": 602
    },
    {
        "id": "1cd063b931506666",
        "type": "group",
        "z": "e9fafc919bcb1bb0",
        "name": "Import heures → recorder.import_statistics (Intuis → HA)",
        "style": {
            "label": true
        },
        "nodes": [
            "2d704099afdb7720",
            "cc620e7aa003eddd",
            "3d53931ad116e962",
            "887d10a1c970d06f",
            "222194434594b82b",
            "28e0c01c67bf8f1a",
            "25f60b7c9b4908c7"
        ],
        "x": 14,
        "y": 719,
        "w": 1492,
        "h": 162
    },
    {
        "id": "40bddeefa0656431",
        "type": "group",
        "z": "e9fafc919bcb1bb0",
        "name": "Rebase base_kwh à J-2 (quotidien 00:01) + garde-fou",
        "style": {
            "label": true
        },
        "nodes": [
            "0820bfa7549022f4",
            "69d019898bb13801",
            "ecccbe1b2a1afe90",
            "428678185e64f81d",
            "a70f6a2cedc558d6",
            "e5e490820ebad235",
            "e4176ff1f4d664e9"
        ],
        "x": 14,
        "y": 899,
        "w": 1432,
        "h": 202
    },
    {
        "id": "3635aba12bfcd685",
        "type": "group",
        "z": "c8fb396ecc5efcfc",
        "name": "Recup des consos Horaire",
        "style": {
            "label": true
        },
        "nodes": [
            "b61e71b6d6f19ece",
            "e887f9be2d84e086",
            "a35e9026e8735096",
            "7d914e261e87ed1e",
            "09643c498e845545",
            "ea173eab5a7b1f3f",
            "5ff0759a08227d28",
            "20ab1ab4c379bbdc",
            "d758a9a23a1fc8f5",
            "ee1936464dcdb204",
            "839e113280f8d64e",
            "11ef43c80b115863",
            "a4ae6594c911a7e0",
            "3f86109f5d6beb72",
            "684785b2a78095a2",
            "e009ac72275552a5",
            "08c328f6c4fe5889",
            "08b89e016f746c15",
            "b299b86b04518d56",
            "4ee703fbb4bdf889",
            "aaa489d26e569f9f",
            "f36776ed9d43e90a",
            "9029c59bd55b8b9e",
            "42fc4bac6bb615b5"
        ],
        "x": 114,
        "y": 719,
        "w": 1132,
        "h": 702
    },
    {
        "id": "55eac72b576d889c",
        "type": "group",
        "z": "e9fafc919bcb1bb0",
        "name": "Import HIER (1h) depuis Intuis → HA recorder.import_statistics",
        "style": {
            "label": true
        },
        "nodes": [
            "4bbff6f268941713",
            "7af8f556aac0a82d",
            "cb27cc16c7c43afc",
            "1f2860ad572e43c5",
            "beccb7f9fcad1b6b",
            "b334d5e806aed874",
            "a74c44a9d300b9e4",
            "1b30ae933cf1de32",
            "c1151738ca0c8042",
            "ee27abf3194d50c8"
        ],
        "x": 14,
        "y": 1239,
        "w": 1632,
        "h": 222
    },
    {
        "id": "e0f310ef645539ec",
        "type": "group",
        "z": "e9fafc919bcb1bb0",
        "name": "Pousse les States vers les sensors",
        "style": {
            "label": true
        },
        "nodes": [
            "a3bfae63e6e3a328",
            "51c63c957e5b6382",
            "d056028a766cc903",
            "bccac2dad26af4b3",
            "9089c50caeda28e0",
            "0bde458557485ee7",
            "f770f934e3b2947a",
            "7c53f51b7e72b35e",
            "6020d2b5c5a7f91c",
            "8a750d7ac05a60a3",
            "bbeb5e685d16d7f2",
            "204f710424894214",
            "574667cf5ab773a7"
        ],
        "x": 2034,
        "y": 639,
        "w": 1072,
        "h": 522
    },
    {
        "id": "76bcd7558fa413aa",
        "type": "group",
        "z": "e9fafc919bcb1bb0",
        "name": "Bilan conso par radiateur (16 août → 6 oct inclus)",
        "style": {
            "label": true
        },
        "nodes": [
            "7d06561d83d9ae30",
            "7bfdf6abc3c6f4a4",
            "2c7d7e6bd284cb92",
            "e175a6bd52325a35",
            "0f6f05ef24faae01",
            "e1f0bcc5f0064327",
            "c9cad622fe8d90c7",
            "a5eeb1e998b414c3"
        ],
        "x": 54,
        "y": 459,
        "w": 1742,
        "h": 202
    },
    {
        "id": "b4a36816213b7b3b",
        "type": "group",
        "z": "c8fb396ecc5efcfc",
        "g": "84c133862c6ab1a2",
        "name": "Définition début et fin de plage",
        "style": {
            "label": true
        },
        "nodes": [
            "08b2ea1c720daa15",
            "a266a93279736ddc",
            "185ddd9b17bb0a37",
            "d841c63b71740859",
            "23fac8d45049a21a",
            "5d7b35ae2e6d9034",
            "6ca8f00ce04e6a05",
            "1e5842fa93ba08f9"
        ],
        "x": 34,
        "y": 359,
        "w": 492,
        "h": 262
    },
    {
        "id": "f7551d3649196f4b",
        "type": "junction",
        "z": "f1e965419e59229c",
        "x": 2300,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "553a4a33f70c2e19",
        "type": "server",
        "name": "Home Assistant",
        "version": 5,
        "addon": false,
        "rejectUnauthorizedCerts": false,
        "ha_boolean": "y|yes|true|on|home|open",
        "connectionDelay": true,
        "cacheJson": true,
        "heartbeat": false,
        "heartbeatInterval": 30,
        "areaSelector": "friendlyName",
        "deviceSelector": "friendlyName",
        "entitySelector": "friendlyName",
        "statusSeparator": ": ",
        "statusYear": "numeric",
        "statusMonth": "numeric",
        "statusDay": "numeric",
        "statusHourCycle": "h23",
        "statusTimeFormat": "h:m",
        "enableGlobalContextStore": true
    },
    {
        "id": "76054f9f12d4abf5",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Chambre d'amis",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Chambre d'amis"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "7cc9b3f8711a30db",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 0 Entrée",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Entrée"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "a8598d514ddc2992",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 2 Salle De Bain Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Salle De Bain Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "5ae30bb9c36e011d",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 3 Chambre Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Chambre Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "8f644be40527e388",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 4 Couloir",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Couloir"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "4b11554c2980b712",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 5 Toilettes Visiteurs",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Toilettes Visiteurs"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cefcb67d6f9bc3da",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 6 Salon",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Salon"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "26429a74f02e051a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 7 Salle à manger Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Salle à manger Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "9f31c4d71a2d6603",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 8 Salle de bains Parents",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Salle de bains Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "303c882f16d16f3f",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 9 Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "69f87646ef646ef7",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consommation Room 11 salle de bains Parents",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consommation salle de bains Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "6dbc88116a89ee2d",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Consomation Totale Chauffage",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Consomation Totale Chauffage"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "Wh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "6c0257c5859242a5",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Mode Maison",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode Maison"
            },
            {
                "property": "icon",
                "value": "mdi:home"
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "dfc0a292cf62b6bf",
        "type": "global-config",
        "env": [
            {
                "name": "username",
                "value": "fc@santoni.ch",
                "type": "str"
            },
            {
                "name": "password",
                "value": "__PWRD__",
                "type": "cred"
            },
            {
                "name": "ClientId",
                "value": "__PWRD__",
                "type": "cred"
            },
            {
                "name": "ClientSecret",
                "value": "__PWRD__",
                "type": "cred"
            }
        ],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.78.2",
            "node-red-contrib-cron-plus": "2.2.4",
            "node-red-contrib-moment": "5.0.0"
        }
    },
    {
        "id": "7b6075a0b55c0b0a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "choix piece",
        "version": 6,
        "entityType": "select",
        "haConfig": [
            {
                "property": "name",
                "value": "choix piece"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "config"
            },
            {
                "property": "options",
                "value": [
                    ""
                ]
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "70c64959424002d3",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "liste_pieces_lens",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "liste_pieces_lens"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": ""
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "b22e94a0f37cb076",
        "type": "mqtt-broker",
        "name": "MQTT",
        "broker": "172.22.22.26",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "f06b30da46b52b62",
        "type": "ha-device-config",
        "name": "Chauffage Entrée",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "cb9e582c8ad85e3e",
        "type": "ha-device-config",
        "name": "Chauffage Salle de bain Filles",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "458fbd4dd07d4ace",
        "type": "ha-device-config",
        "name": "Chauffage Couloir",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "38086847a02d49d8",
        "type": "ha-device-config",
        "name": "Chauffage Salon",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "c1e114bd73b7d75a",
        "type": "ha-device-config",
        "name": "Chauffage Salle de bain Parents",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "5b06070b1069a81f",
        "type": "ha-device-config",
        "name": "Chauffage Chambre Parents",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "be3a41c16e206ddc",
        "type": "ha-device-config",
        "name": "Chauffage Chambre d'amis",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "9150e51b3a4dd1ce",
        "type": "ha-device-config",
        "name": "Chauffage Chambre Filles",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "c3f23377a8977e23",
        "type": "ha-device-config",
        "name": "Chauffage Toilettes Visiteurs",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "bfa569038d17228e",
        "type": "ha-device-config",
        "name": "Chauffage Salle à Manger",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "7b0eafa81b222ac6",
        "type": "ha-device-config",
        "name": "Chauffage Cuisine",
        "hwVersion": "",
        "manufacturer": "Node-RED",
        "model": "",
        "swVersion": ""
    },
    {
        "id": "d95eedd859d8b664",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "f06b30da46b52b62",
        "name": "Température Entrée",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Entrée"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "20256badf8bcbdd4",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "f06b30da46b52b62",
        "name": "Température Consigne Entrée",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Consigne Entrée"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "c77c14d53889e40e",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "f06b30da46b52b62",
        "name": "Fenêtre ouverte entrée",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte entrée"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "63d759f0f3c62f39",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "f06b30da46b52b62",
        "name": "Présence Entrée",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Présence Entrée"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "1b0a97e23f63ce23",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "cb9e582c8ad85e3e",
        "name": "Température Salle De Bain Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Salle De Bain Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "f76b635a04caa4af",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "f06b30da46b52b62",
        "name": "Mode fonctionnement Entrée",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Entrée"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "34586545d535ffd6",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "38086847a02d49d8",
        "name": "Température consigne Salon",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Salon"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "bdeef0ef5efb5cfc",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "38086847a02d49d8",
        "name": "Fenetre ouverte Salon",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenetre ouverte Salon"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "e5f43328f88b6b5d",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "38086847a02d49d8",
        "name": "Détection présence Salon",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Salon"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "27398167c586ce1e",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "38086847a02d49d8",
        "name": "Mode fonctionnement Salon",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Salon"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "67699c44de8c3d4e",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "38086847a02d49d8",
        "name": "Température Salon",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Salon"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "75bbd493b8d6cbaa",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "be3a41c16e206ddc",
        "name": "Température Chambre d'amis",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Chambre d'amis"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "e3d9b4aa57e5eb2a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "be3a41c16e206ddc",
        "name": "Mode fonctionnement Chambre d'amis",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Chambre d'amis"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ae092069eb2baa8f",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "be3a41c16e206ddc",
        "name": "Température consigne Chambre d'amis",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Chambre d'amis"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "8aa169c5137457b4",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "be3a41c16e206ddc",
        "name": "Fenêtre ouverte Chambre d'amis",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Chambre d'amis"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "2ad54ae8b6a0245a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "be3a41c16e206ddc",
        "name": "Présence Chambre d'amis",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Présence Chambre d'amis"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "100a313af5f252be",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "cb9e582c8ad85e3e",
        "name": "Mode fonctionnement Salle De Bain Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Salle De Bain Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "26eff76fdb9da3f4",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "cb9e582c8ad85e3e",
        "name": "Température consigne Salle De Bain Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Salle De Bain Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "a2a9e05d6a0b1bca",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "cb9e582c8ad85e3e",
        "name": "Fenêtre ouverte Salle De Bain Filles",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Salle De Bain Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "691179561d9ee5c9",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "cb9e582c8ad85e3e",
        "name": "Détection présence Salle De Bain Filles",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Salle De Bain Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "d175ed0f639479c1",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "9150e51b3a4dd1ce",
        "name": "Température Chambre Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Chambre Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "4c0cfd77ea47deab",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "9150e51b3a4dd1ce",
        "name": "Mode fonctionnement Chambre Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Chambre Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "98fab7910d34e3e3",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "9150e51b3a4dd1ce",
        "name": "Température consigne Chambre Filles",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Chambre Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "a25d545305d4095a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "9150e51b3a4dd1ce",
        "name": "Fenêtre ouverte Chambre Filles",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Chambre Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "eefcc8439123c565",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "9150e51b3a4dd1ce",
        "name": "Détection présence Chambre Filles",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Chambre Filles"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cac4b902b0b84b30",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "458fbd4dd07d4ace",
        "name": "Température Couloir",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Couloir"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "e02b0c8d47c87143",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "458fbd4dd07d4ace",
        "name": "Mode fonctionnement Couloir",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Couloir"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "7f7134e1363ea26a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "458fbd4dd07d4ace",
        "name": "Température consigne Couloir",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Couloir"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "49266288c9a62c61",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "458fbd4dd07d4ace",
        "name": "Fenêtre ouverte Couloir",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Couloir"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "049114a73bad92df",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "458fbd4dd07d4ace",
        "name": "Détection présence Couloir",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Couloir"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "5d53e3559196a609",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c3f23377a8977e23",
        "name": "Température Toilettes Visiteurs",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Toilettes Visiteurs"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "3f9bcd622b07c830",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c3f23377a8977e23",
        "name": "Mode fonctionnement Toilettes Visiteurs",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Toilettes Visiteurs"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "70c5705e81ca42f9",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c3f23377a8977e23",
        "name": "Température consigne Toilettes Visiteurs",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Toilettes Visiteurs"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "1a58af4eea09dc8f",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c3f23377a8977e23",
        "name": "Fenêtre ouverte Toilettes Visiteurs",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Toilettes Visiteurs"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "5954d5ae6da7f5db",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c3f23377a8977e23",
        "name": "Détection présence Toilettes Visiteurs",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Toilettes Visiteurs"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "c5105ec09fee0f89",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "bfa569038d17228e",
        "name": "Température Salle à manger Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Salle à manger Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "b7341bb3976a1367",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "bfa569038d17228e",
        "name": "Mode fonctionnement Température Salle à manger Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Température Salle à manger Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "4980b75f18d30d53",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "bfa569038d17228e",
        "name": "Température consigne Salle à manger Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Salle à manger Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "bb5a75a41d93970c",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "bfa569038d17228e",
        "name": "Fenêtre ouverte Salle à manger Cuisine",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Salle à manger Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "3773cd11fcbba532",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "bfa569038d17228e",
        "name": "Détection présence Salle à manger Cuisine",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Salle à manger Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "57fa319f12736dcf",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "7b0eafa81b222ac6",
        "name": "Température Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "53b332150a60514d",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c1e114bd73b7d75a",
        "name": "Température Salle De Bain Parents1",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Salle De Bain Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "424bb978f0f6efde",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "7b0eafa81b222ac6",
        "name": "Mode fonctionnement  Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement  Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "8db9b3e6402ad111",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "7b0eafa81b222ac6",
        "name": "Température consigne Cuisine",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "f7a037d0631128ed",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "7b0eafa81b222ac6",
        "name": "Fenêtre ouverte Cuisine",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "f879152761a06a35",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "7b0eafa81b222ac6",
        "name": "Détection présence Cuisine",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Cuisine"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "4b6005e3afbcf039",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c1e114bd73b7d75a",
        "name": "Mode fonctionnement Température Salle De Bain Parents",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Température Salle De Bain Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "489d1dba2e55caf0",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c1e114bd73b7d75a",
        "name": "Température consigne Salle De Bain Parents",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Salle De Bain Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "818cb23a81c12045",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c1e114bd73b7d75a",
        "name": "Fenêtre ouverte Salle De Bain Parents",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Salle De Bain Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "e2f6a2d30e54b216",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c1e114bd73b7d75a",
        "name": "Détection présence Salle De Bain Parents",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Salle De Bain Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "2091f2ca728b6769",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "5b06070b1069a81f",
        "name": "Température Chambre Parents",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température Chambre Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "b6ce81822e82d280",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "5b06070b1069a81f",
        "name": "Mode fonctionnement Température Chambre Parents",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Mode fonctionnement Température Chambre Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": ""
            },
            {
                "property": "unit_of_measurement",
                "value": ""
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ccfe06e1f1664232",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "5b06070b1069a81f",
        "name": "Température consigne Chambre Parents",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Température consigne Chambre Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "temperature"
            },
            {
                "property": "unit_of_measurement",
                "value": "°C"
            },
            {
                "property": "state_class",
                "value": "measurement"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "03657b3c18adda23",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "5b06070b1069a81f",
        "name": "Fenêtre ouverte Chambre Parents",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Fenêtre ouverte Chambre Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "window"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "015c87b01e4d648f",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "5b06070b1069a81f",
        "name": "Détection présence Chambre Parents",
        "version": 6,
        "entityType": "binary_sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Détection présence Chambre Parents"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "presence"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "2de3bd7f4105a055",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Liste des plannings NR",
        "version": 6,
        "entityType": "select",
        "haConfig": [
            {
                "property": "name",
                "value": "Liste des plannings NR"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "config"
            },
            {
                "property": "options",
                "value": [
                    ""
                ]
            }
        ],
        "resend": false,
        "debugEnabled": true
    },
    {
        "id": "f98010fd4ac7980b",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Tmp choix piece",
        "version": 6,
        "entityType": "select",
        "haConfig": [
            {
                "property": "name",
                "value": "Tmp choix piece"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "config"
            },
            {
                "property": "options",
                "value": [
                    ""
                ]
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "entree_hier_entitycfg",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "f06b30da46b52b62",
        "name": "Entrée – conso hier (kWh)",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Entrée – conso hier (kWh)"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "7b221a85b3bf93a9",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "f06b30da46b52b62",
        "name": "Conso Entrée Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Entrée Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f702",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "be3a41c16e206ddc",
        "name": "Conso Chambre d'amis Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Chambre d'amis Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f703",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "cb9e582c8ad85e3e",
        "name": "Conso Salle de bain filles Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Salle de bain filles Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f704",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "9150e51b3a4dd1ce",
        "name": "Conso Chambre filles Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Chambre filles Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f705",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "458fbd4dd07d4ace",
        "name": "Conso Couloir Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Couloir Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f706",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c3f23377a8977e23",
        "name": "Conso Toilettes visiteurs Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Toilettes visiteurs Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f707",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "38086847a02d49d8",
        "name": "Conso Salon Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Salon Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f708",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "bfa569038d17228e",
        "name": "Conso Salle à manger Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Salle à manger Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f709",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "c1e114bd73b7d75a",
        "name": "Conso Salle de bain parents Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Salle de bain parents Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f70a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "7b0eafa81b222ac6",
        "name": "Conso Cuisine Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Cuisine Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "ec1a2b3c4d5e6f70b",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "5b06070b1069a81f",
        "name": "Conso Chambre parents Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Chambre parents Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": "diagnostic"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": "total_increasing"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0001aaaaaaa1a",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Entrée Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Entrée Hourly"
            },
            {
                "property": "icon",
                "value": ""
            },
            {
                "property": "entity_picture",
                "value": ""
            },
            {
                "property": "entity_category",
                "value": ""
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            },
            {
                "property": "state_class",
                "value": ""
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0002bbbbbbb2b",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Chambre d'amis Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Chambre d'amis Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0003ccccccc3c",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Salle de bain filles Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Salle de bain filles Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0004ddddddd4d",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Chambre Filles Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Chambre Filles Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0005eeeeeee5e",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Couloir Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Couloir Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0006ffffff6f6",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso WC Visiteurs Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso WC Visiteurs Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0007aaa1117a1",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Salon Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Salon Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0008bbb2228b2",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Salle à manger Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Salle à manger Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg0009ccc3339c3",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso SDB Parents Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso SDB Parents Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg000addd444ad4",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Cuisine Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Cuisine Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "cfg000beee555be5",
        "type": "ha-entity-config",
        "server": "553a4a33f70c2e19",
        "deviceConfig": "",
        "name": "Conso Chambre Parents Hourly",
        "version": 6,
        "entityType": "sensor",
        "haConfig": [
            {
                "property": "name",
                "value": "Conso Chambre Parents Hourly"
            },
            {
                "property": "device_class",
                "value": "energy"
            },
            {
                "property": "unit_of_measurement",
                "value": "kWh"
            }
        ],
        "resend": false,
        "debugEnabled": false
    },
    {
        "id": "0537953a8c433072",
        "type": "http request",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Send refresh request",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/oauth2/token",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/x-www-form-urlencoded"
            }
        ],
        "x": 1060,
        "y": 160,
        "wires": [
            [
                "8fd2293bce221f2b",
                "972e79dedee2a59f"
            ]
        ]
    },
    {
        "id": "6d8913e4536301d8",
        "type": "inject",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Start",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 140,
        "wires": [
            [
                "2b4ba9f422939106"
            ]
        ]
    },
    {
        "id": "2b4ba9f422939106",
        "type": "change",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Set param request refresh",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t   \"client_id\": $env(\"ClientId\"),\t   \"user_prefix\":\"muller\",\t   \"client_secret\":$env(\"ClientSecret\"),\t   \"grant_type\":\"password\",\t   \"scope\":\"read_muller write_muller\",\t   \"password\":$env(\"password\"),\t   \"username\":$env(\"username\")\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 770,
        "y": 160,
        "wires": [
            [
                "0537953a8c433072",
                "911cb284365dd376"
            ]
        ]
    },
    {
        "id": "f7bb99e9e94723f5",
        "type": "change",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Store tokens & delay",
        "rules": [
            {
                "t": "set",
                "p": "AccessToken",
                "pt": "global",
                "to": "payload.access_token",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "RefreshToken",
                "pt": "global",
                "to": "payload.refresh_token",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "delay",
                "pt": "msg",
                "to": "payload.expires_in*1000-300000",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "status",
                "pt": "msg",
                "to": "OK",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "LastUpdateTime",
                "pt": "global",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1540,
        "y": 100,
        "wires": [
            [
                "b5a35aa53e77a471",
                "4de2743da191dfa8"
            ]
        ]
    },
    {
        "id": "f9016440fc664e26",
        "type": "inject",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Stop",
        "props": [
            {
                "p": "reset",
                "v": "1",
                "vt": "num"
            },
            {
                "p": "status",
                "v": "STOP",
                "vt": "str"
            },
            {
                "p": "delay",
                "v": "1",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 150,
        "y": 200,
        "wires": [
            [
                "b5a35aa53e77a471",
                "4de2743da191dfa8",
                "b0043aa88865992c"
            ]
        ]
    },
    {
        "id": "8fd2293bce221f2b",
        "type": "switch",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "All ok ?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "hask",
                "v": "access_token",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1300,
        "y": 160,
        "wires": [
            [
                "f7bb99e9e94723f5"
            ],
            [
                "8d364c1971adf29a"
            ]
        ],
        "outputLabels": [
            "Response OK",
            "Error"
        ]
    },
    {
        "id": "8d364c1971adf29a",
        "type": "change",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Delay 1 hour on error",
        "rules": [
            {
                "t": "set",
                "p": "delay",
                "pt": "msg",
                "to": "3600000",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "status",
                "pt": "msg",
                "to": "KO",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "NetatmoLastUpdateTime",
                "pt": "global",
                "to": "",
                "tot": "date"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1545,
        "y": 220,
        "wires": [
            [
                "b5a35aa53e77a471",
                "4de2743da191dfa8"
            ]
        ]
    },
    {
        "id": "b5a35aa53e77a471",
        "type": "delay",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Refresh",
        "pauseType": "delayv",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 465,
        "y": 160,
        "wires": [
            [
                "2b4ba9f422939106"
            ]
        ]
    },
    {
        "id": "4de2743da191dfa8",
        "type": "delay",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 465,
        "y": 220,
        "wires": [
            [
                "b0043aa88865992c"
            ]
        ]
    },
    {
        "id": "b0043aa88865992c",
        "type": "function",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Next refresh in...",
        "func": "var d = new Date();\nvar n = d.getTime();\nvar start_time = global.get('LastUpdateTime')||0;\nvar duration = msg.delay/1000;\nvar elapsed_time = Math.round((n - start_time)/1000);\n\nvar remains = new Date(null);\nremains.setSeconds(duration - elapsed_time); // specify value for SECONDS here\nvar remains_h = remains.toISOString().substr(11, 8);\nif (msg.status == \"STOP\") {\n    node.status({});\n    msg.remains = \"00:00:00\";\n    msg.payload = 0;\n    return [null, msg];\n}\nif (elapsed_time < duration) {\n    node.status({fill:msg.status == \"OK\" ? \"blue\" : \"red\",shape:\"dot\", text:remains_h});\n    msg.remains = remains_h;\n    return [ msg, null ];\n}\n\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 300,
        "wires": [
            [
                "4de2743da191dfa8"
            ],
            []
        ]
    },
    {
        "id": "12d5d2c61ab495e1",
        "type": "change",
        "z": "f1e965419e59229c",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "token",
                "pt": "msg",
                "to": "\"Bearer \" & $globalContext(\"AccessToken\")\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 210,
        "y": 600,
        "wires": [
            [
                "9f4428cf84c0c5a4",
                "2a71358817879f82"
            ]
        ]
    },
    {
        "id": "9f4428cf84c0c5a4",
        "type": "http request",
        "z": "f1e965419e59229c",
        "name": "Intuis homedata",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/homesdata",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Authorization",
                "valueType": "msg",
                "valueValue": "token"
            }
        ],
        "x": 1080,
        "y": 600,
        "wires": [
            [
                "d0f9e0b73e61317c",
                "e14ade8bf73a5097",
                "4a1410850d21c3e6",
                "7cd3e0f8be7efe52",
                "b40762ad6ec290be",
                "9a421263a5381c13",
                "04a1f956cf4304b4",
                "d134ed31b6221aa9",
                "b56c80d52ebe553c"
            ]
        ]
    },
    {
        "id": "830ef2a6a18d34b5",
        "type": "inject",
        "z": "f1e965419e59229c",
        "name": "Get Intuis Data",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "450",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 500,
        "wires": [
            [
                "12d5d2c61ab495e1"
            ]
        ]
    },
    {
        "id": "972e79dedee2a59f",
        "type": "debug",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "contrôle authentification",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1230,
        "y": 60,
        "wires": []
    },
    {
        "id": "77fb193bc363b854",
        "type": "http request",
        "z": "f1e965419e59229c",
        "name": "Intuis getconfig",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/syncapi/v1/getconfigs",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Authorization",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/x-www-form-urlencoded"
            }
        ],
        "x": 720,
        "y": 700,
        "wires": [
            [
                "56aa8eb6b7efd007"
            ]
        ]
    },
    {
        "id": "56aa8eb6b7efd007",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "Intuis getconfig",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 920,
        "y": 700,
        "wires": []
    },
    {
        "id": "d0f9e0b73e61317c",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "Intuis homedata",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload.body.homes[0]",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1520,
        "y": 360,
        "wires": []
    },
    {
        "id": "36d8fe0505bc44e7",
        "type": "change",
        "z": "f1e965419e59229c",
        "name": "Set param get config 1",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t   \"home_id\":$globalContext(\"home_id\")\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 500,
        "y": 700,
        "wires": [
            [
                "77fb193bc363b854",
                "fc9f530b0715cf8a"
            ]
        ]
    },
    {
        "id": "ed7f64c8e43f05fd",
        "type": "comment",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "Renseigner les identifiants Intuis connect dans les parametres du NODE",
        "info": "Noeud Set Intuis Creds & Tokens\nrenseigner ClientId, ClientSecret, username et password dans les parametres node-red\n",
        "x": 330,
        "y": 60,
        "wires": []
    },
    {
        "id": "e14ade8bf73a5097",
        "type": "change",
        "z": "f1e965419e59229c",
        "name": "Identifier les pièces",
        "rules": [
            {
                "t": "set",
                "p": "payload.rooms.0.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[0].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.0.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[0].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.1.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[1].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.1.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[1].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.2.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[2].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.2.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[2].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.3.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[3].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.3.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[3].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.4.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[4].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.4.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[4].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.5.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[5].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.5.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[5].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.6.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[6].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.6.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[6].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.7.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[7].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.7.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[7].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.8.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[8].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.8.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[8].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.9.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[9].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.9.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[9].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.10.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[10].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.10.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[10].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.rooms.11.name",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[11].name",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "payload.rooms.11.id",
                "pt": "msg",
                "to": "payload.body.homes[0].rooms[11].id",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1530,
        "y": 400,
        "wires": [
            [
                "8df6b54048e62b07",
                "927cdc45a0782935"
            ]
        ]
    },
    {
        "id": "8df6b54048e62b07",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "Identifier les pièces",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload.rooms",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1890,
        "y": 240,
        "wires": []
    },
    {
        "id": "4a1410850d21c3e6",
        "type": "change",
        "z": "f1e965419e59229c",
        "name": "définir global.home_id et home_name",
        "rules": [
            {
                "t": "set",
                "p": "home_id",
                "pt": "global",
                "to": "payload.body.homes[0].id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "home_name",
                "pt": "global",
                "to": "payload.body.homes[0].name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "2a71358817879f82",
        "type": "delay",
        "z": "f1e965419e59229c",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 440,
        "y": 640,
        "wires": [
            [
                "36d8fe0505bc44e7"
            ]
        ]
    },
    {
        "id": "7cd3e0f8be7efe52",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "Identification routeur",
        "func": "if (msg.payload.body.homes[0].modules[0].type === \"NMG\") {\n    msg.payload = msg.payload.body.homes[0].modules[0];\n    return msg;}\nelse if (msg.payload.body.homes[0].modules[1].type === \"NMG\") {\n    msg.payload = msg.payload.body.homes[0].modules[1];\n    return msg;}\nelse if (msg.payload.body.homes[0].modules[2].type === \"NMG\") {\n    msg.payload = msg.payload.body.homes[0].modules[2];\n    return msg;}\nelse if (msg.payload.body.homes[0].modules[3].type === \"NMG\") {\n    msg.payload = msg.payload.body.homes[0].modules[3];\n    return msg;}\nelse {msg.payload = \"ko\";\n    return msg;}\t \t ",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 820,
        "wires": [
            [
                "68d4cb4ff64ff39b"
            ]
        ]
    },
    {
        "id": "68d4cb4ff64ff39b",
        "type": "change",
        "z": "f1e965419e59229c",
        "name": "définir global routeur_id et routeur_name",
        "rules": [
            {
                "t": "set",
                "p": "routeur_id",
                "pt": "global",
                "to": "payload.id",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "routeur_name",
                "pt": "global",
                "to": "payload.name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1840,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "b40762ad6ec290be",
        "type": "change",
        "z": "f1e965419e59229c",
        "name": "définir rooms_ids ",
        "rules": [
            {
                "t": "set",
                "p": "room0_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[0].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room1_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[1].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room2_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[2].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room3_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[3].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room4_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[4].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room5_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[5].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room6_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[6].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room7_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[7].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room8_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[8].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room9_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[9].id",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "room10_id",
                "pt": "global",
                "to": "payload.body.homes[0].rooms[10].id",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1530,
        "y": 620,
        "wires": [
            [
                "ee0e218d1d034f9e"
            ]
        ]
    },
    {
        "id": "d1967116b75e9126",
        "type": "comment",
        "z": "f1e965419e59229c",
        "name": "A compléter selon nombre de pièces ",
        "info": "",
        "x": 1580,
        "y": 720,
        "wires": []
    },
    {
        "id": "ee0e218d1d034f9e",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "function 1",
        "func": "msg.payload = {\n    room0_id: global.get(\"room0_id\"),\n    room1_id: global.get(\"room1_id\"),\n    room2_id: global.get(\"room2_id\"),\n    room3_id: global.get(\"room3_id\"),\n    room4_id: global.get(\"room4_id\"),\n    room5_id: global.get(\"room5_id\"),\n    room6_id: global.get(\"room6_id\"),\n    room7_id: global.get(\"room7_id\"),\n    room8_id: global.get(\"room8_id\"),\n    room9_id: global.get(\"room9_id\"),\n    room10_id: global.get(\"room10_id\"),\n    room11_id: global.get(\"room11_id\")\n};\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1740,
        "y": 620,
        "wires": [
            [
                "bbd73c3f4bea3734"
            ]
        ]
    },
    {
        "id": "bbd73c3f4bea3734",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "debug 1",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1940,
        "y": 620,
        "wires": []
    },
    {
        "id": "9a421263a5381c13",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "Création ou maj des pièces dans HA",
        "func": "let rooms = msg.payload.body.homes[0].rooms;\nlet roomNames = {};\nlet options = [];\n\nfor (let i = 0; i < rooms.length; i++) {\n    let name = rooms[i].name;\n    let id = rooms[i].id;\n    options.push(name);\n    roomNames[name] = id;\n}\n\n// Sauvegarder pour plus tard\nglobal.set(\"room_name_to_id\", roomNames);\n\n// Envoyer les options à Home Assistant\nmsg.payload = {\n    entity_id: \"input_select.choix_piece1\",\n    options: options\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1590,
        "y": 880,
        "wires": [
            [
                "1aab7a570149f653"
            ]
        ]
    },
    {
        "id": "04a1f956cf4304b4",
        "type": "change",
        "z": "f1e965419e59229c",
        "name": "Identifier les plannings",
        "rules": [
            {
                "t": "set",
                "p": "payload.therm_schedules",
                "pt": "msg",
                "to": "payload.body.homes[0].therm_schedules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1540,
        "y": 500,
        "wires": [
            [
                "3c69e9cb364e7127",
                "3d99f1c79aafeada",
                "c1a497f5d37d9207",
                "5dc7764d3d39daf8",
                "e74fed4909f2228b"
            ]
        ]
    },
    {
        "id": "3c69e9cb364e7127",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "Liste des plannings",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1890,
        "y": 400,
        "wires": []
    },
    {
        "id": "34eef269ea105cbb",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "name": "Mode fonctionnement Maison",
        "entityConfig": "6c0257c5859242a5",
        "version": 0,
        "state": "payload.body.homes[0].therm_mode",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2270,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "d134ed31b6221aa9",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "Mapping Etat",
        "func": "const mode = msg.payload.body.homes[0].therm_mode;\n\nconst mapping = {\n    \"hg\": \"Hors Gel\",\n    \"away\": \"Dehors\",\n    \"schedule\": \"Programmé\",\n    \"home\": \"Maison chauffée\"\n};\n\nmsg.payload.body.homes[0].therm_mode = mapping[mode] || \"inconnu\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1510,
        "y": 560,
        "wires": [
            [
                "34eef269ea105cbb"
            ]
        ]
    },
    {
        "id": "911cb284365dd376",
        "type": "debug",
        "z": "f1e965419e59229c",
        "g": "8a1b9db73a84d263",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 60,
        "wires": []
    },
    {
        "id": "954f746967d8a4c6",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "liste pieces",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2490,
        "y": 880,
        "wires": []
    },
    {
        "id": "1aab7a570149f653",
        "type": "ha-update-config",
        "z": "f1e965419e59229c",
        "name": "Update liste de choix pièce",
        "server": "553a4a33f70c2e19",
        "entityConfig": "7b6075a0b55c0b0a",
        "version": 0,
        "outputProperties": [],
        "x": 2260,
        "y": 880,
        "wires": [
            [
                "954f746967d8a4c6"
            ]
        ]
    },
    {
        "id": "3d99f1c79aafeada",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "Extrait les planififactions",
        "func": "// On récupère la liste des plannings\nconst plannings = msg.payload.body.homes[0].therm_schedules;\nconst outMsgs = [];\n\nfor (let i = 0; i < plannings.length; i++) {\n    const planning = plannings[i];\n    const entity_id = `input_text.therm_schedule_${planning.id}`;\n    const schedule_json = JSON.stringify(planning);\n\n    outMsgs.push({\n        payload: {\n            entity_id: entity_id,\n            value: schedule_json\n        }\n    });\n}\n\n// On sort un message par planning\nreturn [outMsgs];\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1910,
        "y": 360,
        "wires": [
            []
        ]
    },
    {
        "id": "927cdc45a0782935",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "Extrait les pièces",
        "func": "// Function Node en sortie de ton appel API\nconst home = msg.payload.body.homes[0].rooms;\nmsg.payload = {\n  entity_id: \"sensor.liste_pieces_lens\",\n  state: new Date().toISOString(),\n  attributes: {\n    raw_json: home     // la totalité de l’objet home\n  }\n};\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1890,
        "y": 180,
        "wires": [
            [
                "294e794de972ac36",
                "6f06e9e77d12c64b"
            ]
        ]
    },
    {
        "id": "294e794de972ac36",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "Liste des pièces",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2240,
        "y": 100,
        "wires": []
    },
    {
        "id": "6f06e9e77d12c64b",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "name": "Liste Pièces",
        "entityConfig": "70c64959424002d3",
        "version": 0,
        "state": "payload.state",
        "stateType": "msg",
        "attributes": [
            {
                "property": "Attributes",
                "value": "payload.attributes",
                "valueType": "msg"
            }
        ],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2230,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "fc9f530b0715cf8a",
        "type": "http request",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Intuis homestatus",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/syncapi/v1/homestatus",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Authorization",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/x-www-form-urlencoded"
            }
        ],
        "x": 630,
        "y": 1000,
        "wires": [
            [
                "38f2e338ee2f0c53",
                "10ec6696ed8ffdbc",
                "c89cd37deb502b6e",
                "246e8b3fbb94966b",
                "da032647e8394bc7",
                "177ef5b440ff3b10",
                "320438fe15437990",
                "cac1072fd05e3978",
                "475273f619e07148",
                "825482ae8054ded6",
                "8157172cb4371bda",
                "4164cee609b6fbc9",
                "d8b5d25dc8eccd40",
                "c87790293566b3ed",
                "4463d66b0b811553",
                "ef41488370a3da7c",
                "f1bb973db6a7419f",
                "9aaf59788fe975dc",
                "ae9ae3d6db70bc10",
                "2b0d045fe7e68469",
                "8c3753d388c2d13f",
                "2a725d9e7481226e",
                "d17f38f0345c4336",
                "dba0015b978cd3bf",
                "e01ac648b59502d4",
                "fd645b38f6867145",
                "b8dffacf14b14977",
                "6884f996857e6917",
                "ba9e7bf44175a4f4",
                "f84f472d6afd7403",
                "6ac47d41f757a042",
                "290e5aa38a39cf3c",
                "03775eeb0b6cec66",
                "2001a6a15d431f52",
                "22eea655998ce461",
                "7f8709104a52bcd0",
                "18525a6ce7300a2d",
                "d96ba9496e94456c",
                "fb71b92c165d2e58",
                "06841b92d489b72f",
                "4775b98450107acc",
                "2fef7d661e1314b8",
                "125e2b3f0c624ce1",
                "0cd8258c7408be65",
                "abf4faf2e79038ed",
                "1eb6909e3b3c5cb8",
                "8b0461d8f10574db",
                "0764c479ea31db19",
                "1abff91bfa3d21b1",
                "034326fe1359a1f8",
                "64f2ab526f716e35",
                "ab4254c1c0fcd9b7",
                "1849db0f5f28349b",
                "bba581a115bc3210",
                "b2d4fda8d59af55d",
                "7f6d47927e4b0f0d"
            ]
        ]
    },
    {
        "id": "38f2e338ee2f0c53",
        "type": "debug",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Intuis homestatus",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload.body",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 980,
        "wires": []
    },
    {
        "id": "10ec6696ed8ffdbc",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Entrée",
        "entityConfig": "d95eedd859d8b664",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room0_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 960,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "ef41488370a3da7c",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Entrée",
        "entityConfig": "f76b635a04caa4af",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room0_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 990,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "c89cd37deb502b6e",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Entrée",
        "entityConfig": "20256badf8bcbdd4",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room0_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 980,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "320438fe15437990",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Entrée",
        "entityConfig": "c77c14d53889e40e",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room0_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 960,
        "y": 1220,
        "wires": [
            []
        ]
    },
    {
        "id": "cac1072fd05e3978",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Entrée",
        "entityConfig": "63d759f0f3c62f39",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room0_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 970,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "246e8b3fbb94966b",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Chambre d'amis",
        "entityConfig": "75bbd493b8d6cbaa",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room1_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 980,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "da032647e8394bc7",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Chambre D’amis",
        "entityConfig": "e3d9b4aa57e5eb2a",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room1_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1010,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "177ef5b440ff3b10",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Chambre D’amis",
        "entityConfig": "ae092069eb2baa8f",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room1_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1020,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "475273f619e07148",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Chambre D’amis",
        "entityConfig": "8aa169c5137457b4",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room1_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 990,
        "y": 1580,
        "wires": [
            []
        ]
    },
    {
        "id": "825482ae8054ded6",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Chambre D’amis",
        "entityConfig": "2ad54ae8b6a0245a",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room1_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1000,
        "y": 1640,
        "wires": [
            []
        ]
    },
    {
        "id": "8157172cb4371bda",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Salle De Bain Filles",
        "entityConfig": "1b0a97e23f63ce23",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room2_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1250,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "4164cee609b6fbc9",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Salle De Bain Filles",
        "entityConfig": "100a313af5f252be",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room2_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1300,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "d8b5d25dc8eccd40",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Salle De Bain Filles",
        "entityConfig": "26eff76fdb9da3f4",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room2_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1270,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "c87790293566b3ed",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Salle De Bain Filles",
        "entityConfig": "a2a9e05d6a0b1bca",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room2_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1250,
        "y": 1220,
        "wires": [
            []
        ]
    },
    {
        "id": "4463d66b0b811553",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Salle De Bain Filles",
        "entityConfig": "691179561d9ee5c9",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room2_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1260,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "64f2ab526f716e35",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Chambre Filles",
        "entityConfig": "d175ed0f639479c1",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room3_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1280,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "9aaf59788fe975dc",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Chambre Filles",
        "entityConfig": "4c0cfd77ea47deab",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room3_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1300,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "f1bb973db6a7419f",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Chambre Filles",
        "entityConfig": "98fab7910d34e3e3",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room3_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1300,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "ae9ae3d6db70bc10",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Chambre Filles",
        "entityConfig": "a25d545305d4095a",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room3_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1290,
        "y": 1580,
        "wires": [
            []
        ]
    },
    {
        "id": "2b0d045fe7e68469",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Chambre Filles",
        "entityConfig": "eefcc8439123c565",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room3_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1290,
        "y": 1640,
        "wires": [
            []
        ]
    },
    {
        "id": "2a725d9e7481226e",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Couloir",
        "entityConfig": "e02b0c8d47c87143",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room4_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1600,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "d17f38f0345c4336",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Couloir",
        "entityConfig": "7f7134e1363ea26a",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room4_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1600,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "dba0015b978cd3bf",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Couloir",
        "entityConfig": "49266288c9a62c61",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room4_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1590,
        "y": 1220,
        "wires": [
            []
        ]
    },
    {
        "id": "e01ac648b59502d4",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Couloir",
        "entityConfig": "049114a73bad92df",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room4_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1600,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "8c3753d388c2d13f",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Couloir",
        "entityConfig": "cac4b902b0b84b30",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room4_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1580,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "b8dffacf14b14977",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Toilettes Visiteurs",
        "entityConfig": "3f9bcd622b07c830",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room5_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1600,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "6884f996857e6917",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Toilettes Visiteurs",
        "entityConfig": "70c5705e81ca42f9",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room5_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1610,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "ba9e7bf44175a4f4",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Toilettes Visiteurs",
        "entityConfig": "1a58af4eea09dc8f",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room5_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1590,
        "y": 1580,
        "wires": [
            []
        ]
    },
    {
        "id": "f84f472d6afd7403",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Toilettes Visiteurs",
        "entityConfig": "5954d5ae6da7f5db",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room5_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1600,
        "y": 1640,
        "wires": [
            []
        ]
    },
    {
        "id": "fd645b38f6867145",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Toilettes Visiteurs",
        "entityConfig": "5d53e3559196a609",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room5_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1580,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "290e5aa38a39cf3c",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Salle à manger",
        "entityConfig": "b7341bb3976a1367",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room7_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1920,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "03775eeb0b6cec66",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Salle à manger",
        "entityConfig": "4980b75f18d30d53",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room7_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1890,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "2001a6a15d431f52",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Salle à manger",
        "entityConfig": "bb5a75a41d93970c",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room7_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1870,
        "y": 1580,
        "wires": [
            []
        ]
    },
    {
        "id": "22eea655998ce461",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Salle à manger",
        "entityConfig": "3773cd11fcbba532",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room7_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1880,
        "y": 1640,
        "wires": [
            []
        ]
    },
    {
        "id": "6ac47d41f757a042",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Salle à manger",
        "entityConfig": "c5105ec09fee0f89",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room7_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1870,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "7f8709104a52bcd0",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Cuisine",
        "entityConfig": "57fa319f12736dcf",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room9_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2260,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "18525a6ce7300a2d",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Cuisine",
        "entityConfig": "424bb978f0f6efde",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room9_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2280,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "d96ba9496e94456c",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Cuisine",
        "entityConfig": "8db9b3e6402ad111",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room9_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2280,
        "y": 1520,
        "wires": [
            []
        ]
    },
    {
        "id": "fb71b92c165d2e58",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Cuisine",
        "entityConfig": "f7a037d0631128ed",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room9_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2270,
        "y": 1580,
        "wires": [
            []
        ]
    },
    {
        "id": "06841b92d489b72f",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Cuisine",
        "entityConfig": "f879152761a06a35",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room9_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2280,
        "y": 1640,
        "wires": [
            []
        ]
    },
    {
        "id": "2fef7d661e1314b8",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Salle De Bain Parents",
        "entityConfig": "4b6005e3afbcf039",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room8_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2250,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "125e2b3f0c624ce1",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Salle De Bain Parents",
        "entityConfig": "489d1dba2e55caf0",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room8_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2220,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "0cd8258c7408be65",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Salle De Bain Parents",
        "entityConfig": "818cb23a81c12045",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room8_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2200,
        "y": 1220,
        "wires": [
            []
        ]
    },
    {
        "id": "abf4faf2e79038ed",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Salle De Bain Parents",
        "entityConfig": "e2f6a2d30e54b216",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room8_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2210,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "4775b98450107acc",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Salle De Bain Parents",
        "entityConfig": "53b332150a60514d",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room8_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2190,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "8b0461d8f10574db",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Chambre Parents",
        "entityConfig": "b6ce81822e82d280",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room10_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2660,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "0764c479ea31db19",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Chambre Parents",
        "entityConfig": "ccfe06e1f1664232",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room10_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2570,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "1abff91bfa3d21b1",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Chambre Parents",
        "entityConfig": "03657b3c18adda23",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room10_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2550,
        "y": 1220,
        "wires": [
            []
        ]
    },
    {
        "id": "034326fe1359a1f8",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Chambre Parents",
        "entityConfig": "015c87b01e4d648f",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room10_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2560,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "1eb6909e3b3c5cb8",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Chambre Parents",
        "entityConfig": "2091f2ca728b6769",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room10_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2540,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "ab4254c1c0fcd9b7",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température Salon",
        "entityConfig": "67699c44de8c3d4e",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room6_id') })[0].therm_measured_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1870,
        "y": 1120,
        "wires": [
            []
        ]
    },
    {
        "id": "1849db0f5f28349b",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Mode fonctionnement Salon",
        "entityConfig": "27398167c586ce1e",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room6_id') })[0].therm_setpoint_mode",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1900,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "bba581a115bc3210",
        "type": "ha-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Température consigne Salon",
        "entityConfig": "34586545d535ffd6",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room6_id') })[0].therm_setpoint_temperature",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1900,
        "y": 1200,
        "wires": [
            []
        ]
    },
    {
        "id": "b2d4fda8d59af55d",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Fenêtre ouverte Salon",
        "entityConfig": "bdeef0ef5efb5cfc",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room6_id') })[0].open_window",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1880,
        "y": 1240,
        "wires": [
            []
        ]
    },
    {
        "id": "7f6d47927e4b0f0d",
        "type": "ha-binary-sensor",
        "z": "f1e965419e59229c",
        "g": "82fdc54c029e354a",
        "name": "Détection présence Salon",
        "entityConfig": "e5f43328f88b6b5d",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room6_id') })[0].presence",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1890,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "c1a497f5d37d9207",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "Publier chaque planning MQTT",
        "func": "// Extrait tous les plannings de la réponse API et les publie chacun sur leur topic\nconst plannings = msg.payload.body.homes[0].therm_schedules;\nconst outMsgs = [];\nfor (let i = 0; i < plannings.length; i++) {\n    const planning = plannings[i];\n    const id = planning.id;\n    const topic = `plannings/therm_schedule_${id}`;\n    outMsgs.push({\n        topic: topic,\n        payload: JSON.stringify(planning),\n        retain: true,\n        from_sync: true\n    });\n}\nreturn [outMsgs];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1930,
        "y": 300,
        "wires": [
            [
                "01b394750389fb8f",
                "09f6da0d5a55d0db"
            ]
        ]
    },
    {
        "id": "09f6da0d5a55d0db",
        "type": "mqtt out",
        "z": "f1e965419e59229c",
        "name": "MQTT publish planning",
        "topic": "",
        "qos": "0",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "b22e94a0f37cb076",
        "x": 2270,
        "y": 300,
        "wires": []
    },
    {
        "id": "01b394750389fb8f",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "Publication MQTT",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2250,
        "y": 240,
        "wires": []
    },
    {
        "id": "cc3714a460f5cecb",
        "type": "link in",
        "z": "f1e965419e59229c",
        "name": "link in 1",
        "links": [
            "19f8fcc565a1a54f"
        ],
        "x": 185,
        "y": 700,
        "wires": [
            [
                "12d5d2c61ab495e1"
            ]
        ]
    },
    {
        "id": "5b427e597fc0e2d6",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "debug 3",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2480,
        "y": 460,
        "wires": []
    },
    {
        "id": "e023fa67c9f00241",
        "type": "ha-update-config",
        "z": "f1e965419e59229c",
        "name": "Update liste des plannings",
        "server": "553a4a33f70c2e19",
        "entityConfig": "2de3bd7f4105a055",
        "version": 0,
        "outputProperties": [],
        "x": 2260,
        "y": 480,
        "wires": [
            [
                "5b427e597fc0e2d6"
            ]
        ]
    },
    {
        "id": "5dc7764d3d39daf8",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "function 4",
        "func": "// On cherche la bonne racine dans msg.payload\nlet schedules = null;\nif (msg.payload && msg.payload.body && msg.payload.body.homes) {\n    schedules = msg.payload.body.homes[0]?.therm_schedules;\n} else if (msg.payload && msg.payload.homes) {\n    schedules = msg.payload.homes[0]?.therm_schedules;\n}\n\n// Sécurité\nif (!Array.isArray(schedules)) {\n    node.warn(\"Pas de therm_schedules trouvé\");\n    msg.payload = [];\n    return msg;\n}\n\n// On filtre pour ne garder que les plannings de chauffage (type === 'therm')\nlet planning_names = schedules\n    .filter(s => s.type === \"therm\" && s.name && s.name.trim() !== \"\")\n    .map(s => s.name.trim());\n\n// Option : enlever les doublons (si besoin)\nplanning_names = [...new Set(planning_names)];\n\n// Prépare pour Home Assistant input_select.set_options\nmsg.payload = {\n    domain: \"input_select\",\n    service: \"set_options\",\n    data: {\n        entity_id: \"input_select.planning_chauffage\",\n        options: planning_names\n    }\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1860,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "e74fed4909f2228b",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "select.liste_des_plannings_nr",
        "func": "let scheds = msg.payload.body.homes[0].therm_schedules;\nlet planningNames = {};\nlet options = [];\n\nfor (let i = 0; i < scheds.length; i++) {\n    let name = scheds[i].name;\n    let id = scheds[i].id;\n    options.push(name);\n    planningNames[name] = id;\n}\n\n// On stocke pour la suite (si besoin d’un mapping nom > id)\nglobal.set(\"planning_name_to_id\", planningNames);\n\n// Format attendu par ha-update-config\nmsg.payload = {\n    entity_id: \"select.liste_des_plannings_nr\",\n    options: options\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1930,
        "y": 500,
        "wires": [
            [
                "e023fa67c9f00241"
            ]
        ]
    },
    {
        "id": "b56c80d52ebe553c",
        "type": "function",
        "z": "f1e965419e59229c",
        "name": "Création ou maj des pièces dans HA",
        "func": "let rooms = msg.payload.body.homes[0].rooms;\nlet roomNames = {};\nlet options = [];\n\nfor (let i = 0; i < rooms.length; i++) {\n    let name = rooms[i].name;\n    let id = rooms[i].id;\n    options.push(name);\n    roomNames[name] = id;\n}\n\n// Sauvegarder pour plus tard\nglobal.set(\"room_name_to_id\", roomNames);\n\n// Envoyer les options à Home Assistant\nmsg.payload = {\n    entity_id: \"input_select.tmp_choix_piece\",\n    options: options\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1590,
        "y": 760,
        "wires": [
            [
                "3f237a0aa033a7f0"
            ]
        ]
    },
    {
        "id": "3f237a0aa033a7f0",
        "type": "ha-update-config",
        "z": "f1e965419e59229c",
        "name": "Update liste de choix pièce",
        "server": "553a4a33f70c2e19",
        "entityConfig": "f98010fd4ac7980b",
        "version": 0,
        "outputProperties": [],
        "x": 2260,
        "y": 760,
        "wires": [
            [
                "e1b0e2553aa48979"
            ]
        ]
    },
    {
        "id": "e1b0e2553aa48979",
        "type": "debug",
        "z": "f1e965419e59229c",
        "name": "liste pieces",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2490,
        "y": 760,
        "wires": []
    },
    {
        "id": "2d704099afdb7720",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "1cd063b931506666",
        "name": "Build gethomemeasure: depuis J-1 00:00 local → maintenant",
        "func": "// Build gethomemeasure: J-1 00:00 (local) → maintenant, échelle 1h\nconst home_id  = global.get('home_id');\nconst bridge   = global.get('routeur_id');\n\nconst room_ids = [\n  global.get('room0_id'), global.get('room1_id'), global.get('room2_id'),\n  global.get('room3_id'), global.get('room4_id'), global.get('room5_id'),\n  global.get('room6_id'), global.get('room7_id'), global.get('room8_id'),\n  global.get('room9_id'), global.get('room10_id')\n];\n\n// --- TOKEN ---\nconst rawToken = global.get('AccessToken') || global.get('intuis_token') || global.get('token');\nif (!rawToken) { node.error(\"Token Intuis introuvable\"); return null; }\nmsg.token = rawToken.startsWith('Bearer ') ? rawToken : `Bearer ${rawToken}`;\n\n// --- TZ cohérent ---\nconst tz = global.get('tz') || \"Europe/Paris\";\n\n// \"now\" en local TZ\nconst nowLocal = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));\n// Minuit local aujourd’hui\nconst todayLocalMid = new Date(nowLocal); todayLocalMid.setHours(0,0,0,0);\n// J-1 minuit local\nconst j2LocalMid = new Date(todayLocalMid); j2LocalMid.setDate(j2LocalMid.getDate()-1);\n\nmsg.payload = {\n  date_begin: Math.floor(j2LocalMid.getTime()/1000),\n  date_end:   Math.floor(nowLocal.getTime()/1000),\n  scale: \"1hour\",\n  app_identifier: \"app_muller\",\n  home: {\n    id: home_id,\n    rooms: room_ids.map(id => ({\n      id,\n      bridge,\n      type: \"sum_energy_elec$0\"\n    }))\n  }\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 760,
        "wires": [
            [
                "cc620e7aa003eddd"
            ]
        ]
    },
    {
        "id": "cc620e7aa003eddd",
        "type": "http request",
        "z": "e9fafc919bcb1bb0",
        "g": "1cd063b931506666",
        "name": "Intuis gethomemeasure (1hour)",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/gethomemeasure",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 550,
        "y": 840,
        "wires": [
            [
                "3d53931ad116e962",
                "28e0c01c67bf8f1a"
            ]
        ]
    },
    {
        "id": "3d53931ad116e962",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "1cd063b931506666",
        "name": "Prépare les imports (cumul kWh + dédup)",
        "func": "// === Prépare les imports (toujours envoyer, même sans changement) ===\n\n// Map RoomID → statistic_id + nom facultatif\nconst MAP = {\n  '3165697331': { id:'sensor.conso_entree_hourly',               name:\"Conso Entrée Hourly\" },\n  '3330257038': { id:'sensor.conso_chambre_d_amis_hourly',       name:\"Conso Chambre d'amis Hourly\" },\n  '2979072780': { id:'sensor.conso_salle_de_bain_filles_hourly', name:\"Conso SDB Filles Hourly\" },\n  '3957213003': { id:'sensor.conso_chambre_filles_hourly',       name:\"Conso Chambre Filles Hourly\" },\n  '3807033309': { id:'sensor.conso_couloir_hourly',              name:\"Conso Couloir Hourly\" },\n  '3864339241': { id:'sensor.conso_toilettes_visiteurs_hourly',  name:\"Conso WC Visiteurs Hourly\" },\n  '2064991252': { id:'sensor.conso_salon_hourly',                name:\"Conso Salon Hourly\" },\n  '3761003540': { id:'sensor.conso_salle_a_manger_hourly',       name:\"Conso Salle à manger Hourly\" },\n  '3357075329': { id:'sensor.conso_salle_de_bain_parents_hourly',name:\"Conso SDB Parents Hourly\" },\n  '1668330398': { id:'sensor.conso_cuisine_hourly',              name:\"Conso Cuisine Hourly\" },\n  '1707740468': { id:'sensor.conso_chambre_parents_hourly',      name:\"Conso Chambre Parents Hourly\" }\n};\n\n// Baselines (kWh) “théoriques” (EOD J-2, via rebase J-2)\nconst baseAll = global.get('base_kwh') || {};\n\n// Réponse Intuis\nconst rooms = msg.payload?.body?.home?.rooms || [];\nif (!rooms.length) { node.warn('Pas de rooms dans la réponse Intuis'); return null; }\n\nconst outMsgs = [];\nconst STORE = 'file';\nfunction cget(k){ try { return context.get(k, STORE); } catch(e) { return context.get(k); } }\nfunction cset(k,v){ try { context.set(k,v,STORE); } catch(e) { context.set(k,v); } }\n\n// util: jour/heure locales\nconst tz = global.get('tz') || \"Europe/Paris\";\nfunction localParts(ms) {\n  const d = new Date(ms);\n  const dayKey = new Intl.DateTimeFormat('en-CA', {timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'}).format(d); // YYYY-MM-DD\n  const hour   = Number(new Intl.DateTimeFormat('fr-FR', {timeZone: tz, hour:'2-digit', hour12:false}).format(d)); // 0..23\n  return { dayKey, hour };\n}\n\nconst HOUR_MS = 3600 * 1000;\n\nfor (const r of rooms){\n  const meta = MAP[r.id]; if (!meta) continue;\n  const statId = meta.id;\n\n  const m = r?.measures?.[0];\n  const vals = Array.isArray(m?.value) ? m.value : [];\n  if (!vals.length) continue;\n\n  const stepSec  = Number(m?.step_time) || 3600;           // secondes\n  const edge0Sec = Number(m?.beg_time) - stepSec/2;        // début du 1er créneau (s, UTC)\n\n  // Ancre incrémentale persistée: pour continuité entre runs (ex: 23:00 -> 00:00)\n  const prevSumKey   = `import_prev_sum_${statId}`;\n  const prevStartKey = `import_prev_start_${statId}`;\n  let prevSum   = Number(cget(prevSumKey));\n  let prevStart = Number(cget(prevStartKey));\n\n  // Base théorique (EOD J-2) si aucune ancre disponible\n  const baseTheo = Number(baseAll[statId]);\n\n  // Cumul depuis minuit (local) pour la journée courante (reset au changement de dayKey)\n  let runKwhFromMidnight = 0;\n  let lastDayKey = null;\n\n  // Base de journée explicitement utilisée (pour idempotence si reimport de mêmes heures)\n  const dayBaseCache = {}; // dayKey -> base kWh (ancre 00:00 de ce jour)\n\n  const stats = [];\n  for (let i = 0; i < vals.length; i++) {\n    const v = Array.isArray(vals[i]) ? vals[i][0] : undefined;\n    const n = (typeof v === 'number' && Number.isFinite(v)) ? v\n          : (typeof v === 'string' && v.trim() !== '' && Number.isFinite(+v)) ? +v\n          : NaN;\n    if (!Number.isFinite(n)) continue;\n\n    // --- TOP OF HOUR (HA exige mm:ss = 00:00) ---\n    const startSecRaw = edge0Sec + i * stepSec;                 // secondes UTC\n    const startMsSnap = Math.floor((startSecRaw * 1000) / HOUR_MS) * HOUR_MS;\n    const d = new Date(startMsSnap);\n    d.setUTCMinutes(0, 0, 0);                                   // 00:00.000\n    const startMs  = d.getTime();\n    const startISO = d.toISOString();\n\n    // Gestion du jour local\n    const { dayKey, hour } = localParts(startMs);\n    if (lastDayKey === null || dayKey !== lastDayKey) {\n      runKwhFromMidnight = 0;\n      lastDayKey = dayKey;\n    }\n    if (!(dayKey in dayBaseCache)) {\n      // Si on connaît l’ancre (ex: 23:00 d’hier), on s’en sert pour today 00:00\n      if (hour === 0 && Number.isFinite(prevSum) && Number.isFinite(prevStart) && (startMs - prevStart === HOUR_MS)) {\n        dayBaseCache[dayKey] = prevSum;\n      } else {\n        // Sinon: fallback sur baseTheo (EOD J-2) ou prevSum (continuité), ou 0\n        dayBaseCache[dayKey] = Number.isFinite(baseTheo) ? baseTheo\n                             : Number.isFinite(prevSum)  ? prevSum\n                             : 0;\n      }\n    }\n\n    // Ajout de la conso horaire (Wh -> kWh)\n    runKwhFromMidnight += n / 1000;\n\n    // Calcul sum: priorité à la continuité parfaite d’heure en heure,\n    // sinon base de la journée + cumul depuis 00:00 local\n    let sum;\n    if (Number.isFinite(prevSum) && Number.isFinite(prevStart) && (startMs - prevStart === HOUR_MS)) {\n      sum = Number((prevSum + (n/1000)).toFixed(3));\n    } else {\n      sum = Number((dayBaseCache[dayKey] + runKwhFromMidnight).toFixed(3));\n    }\n\n    // Toujours pousser le point, même si inchangé\n    stats.push({ start: startISO, sum: sum, state: sum });\n\n    // Avance l’ancre incrémentale pour le point suivant\n    prevSum   = sum;\n    prevStart = startMs;\n  }\n\n  if (!stats.length) continue;\n\n  // MàJ des ancres persistées (pour le prochain run)\n  const lastMs = Date.parse(stats[stats.length - 1].start) || 0;\n  if (lastMs) {\n    cset(prevStartKey, lastMs);\n    cset(prevSumKey,   stats[stats.length - 1].sum);\n  }\n\n  const payload = {\n    has_mean: false,\n    has_sum: true,\n    statistic_id: statId,\n    source: \"recorder\",\n    unit_of_measurement: \"kWh\",\n    stats\n  };\n\n  outMsgs.push({\n    payload,\n    _preview: { sensor: statId, count: stats.length, first: stats[0].start, last: stats[stats.length-1].start }\n  });\n}\n\nif (!outMsgs.length){\n  node.status({fill:\"green\",shape:\"dot\",text:\"rien à importer\"});\n  return null;\n}\nreturn [ outMsgs ];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 840,
        "wires": [
            [
                "887d10a1c970d06f",
                "222194434594b82b",
                "a3bfae63e6e3a328"
            ]
        ]
    },
    {
        "id": "887d10a1c970d06f",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "g": "1cd063b931506666",
        "name": "Aperçu import (id + nb + bornes)",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1330,
        "y": 760,
        "wires": []
    },
    {
        "id": "222194434594b82b",
        "type": "api-call-service",
        "z": "e9fafc919bcb1bb0",
        "g": "1cd063b931506666",
        "name": "Recorder: Import statistics",
        "server": "553a4a33f70c2e19",
        "version": 7,
        "debugenabled": false,
        "action": "recorder.import_statistics",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "$$.payload",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "recorder",
        "service": "import_statistics",
        "x": 1350,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "28e0c01c67bf8f1a",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "g": "1cd063b931506666",
        "name": "debug 8",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 820,
        "y": 760,
        "wires": []
    },
    {
        "id": "25f60b7c9b4908c7",
        "type": "cronplus",
        "z": "e9fafc919bcb1bb0",
        "g": "1cd063b931506666",
        "name": "Toutes les 2h à :01 (cron+)",
        "outputField": "payload",
        "timeZone": "Europe/Zurich",
        "storeName": "",
        "commandResponseMsgOutput": "output1",
        "defaultLocation": "",
        "defaultLocationType": "default",
        "outputs": 1,
        "options": [
            {
                "name": "every2h_01",
                "topic": "cron/hourly2",
                "payloadType": "default",
                "payload": "",
                "expressionType": "cron",
                "expression": "30 */2 * * *",
                "location": "",
                "offset": "0",
                "solarType": "all",
                "solarEvents": "sunrise,sunset"
            }
        ],
        "x": 180,
        "y": 840,
        "wires": [
            [
                "2d704099afdb7720"
            ]
        ]
    },
    {
        "id": "0820bfa7549022f4",
        "type": "inject",
        "z": "e9fafc919bcb1bb0",
        "g": "40bddeefa0656431",
        "name": "Chaque jour 00:01",
        "props": [],
        "repeat": "",
        "crontab": "02 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 960,
        "wires": [
            [
                "e4176ff1f4d664e9"
            ]
        ]
    },
    {
        "id": "69d019898bb13801",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "40bddeefa0656431",
        "name": "Guard rebase unique (par jour J-2)",
        "func": "const tz = global.get('tz') || \"Europe/Paris\";\nconst STORE = 'file';\nfunction cget(k){ try{ return context.get(k, STORE);}catch(e){return context.get(k);} }\nfunction cset(k,v){ try{ context.set(k, v, STORE);}catch(e){ context.set(k,v);} }\n\n// now en local TZ\nconst nowLocal = new Date(new Date().toLocaleString('en-US',{timeZone: tz}));\nconst todayMid = new Date(nowLocal); todayMid.setHours(0,0,0,0);\nconst dMinus2Mid = new Date(todayMid); dMinus2Mid.setDate(dMinus2Mid.getDate()-2);\n\nconst dayStr = new Intl.DateTimeFormat(\"en-CA\", { timeZone: tz, year: \"numeric\", month: \"2-digit\", day: \"2-digit\" }).format(dMinus2Mid);\nconst doneKey = `rebase_j2_done_${dayStr}`;\n\nif (!msg.force && cget(doneKey)){\n  node.status({fill:\"green\", shape:\"ring\", text:`Rebase J-2 déjà fait (${dayStr})`});\n  return null;\n}\nmsg._rebase_done_key = doneKey;\nmsg._rebase_day = dayStr;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 1060,
        "wires": [
            [
                "e5e490820ebad235"
            ]
        ]
    },
    {
        "id": "ecccbe1b2a1afe90",
        "type": "http request",
        "z": "e9fafc919bcb1bb0",
        "g": "40bddeefa0656431",
        "name": "Intuis gethomemeasure (1day)",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/gethomemeasure",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 730,
        "y": 1040,
        "wires": [
            [
                "428678185e64f81d"
            ]
        ],
        "info": "\"sensor.conso_entree_hourly\":33.543,\r\n\"sensor.conso_chambre_d_amis_hourly\":6.308,\r\n\"sensor.conso_salle_de_bain_filles_hourly\":0.697,\r\n\"sensor.conso_chambre_filles_hourly\":9.566,\r\n\"sensor.conso_couloir_hourly\":11.585,\r\n\"sensor.conso_toilettes_visiteurs_hourly\":5.229,\r\n\"sensor.conso_salon_hourly\":10.562,\r\n\"sensor.conso_salle_a_manger_hourly\":11.094,\r\n\"sensor.conso_salle_de_bain_parents_hourly\":13.042,\r\n\"sensor.conso_cuisine_hourly\":28.694,\r\n\"sensor.conso_chambre_parents_hourly\":3.825\r\n"
    },
    {
        "id": "428678185e64f81d",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "40bddeefa0656431",
        "name": "Rebase base_kwh avec conso J-2 (avec commit unique)",
        "func": "// Met à jour base_kwh := base_kwh + conso(J-2)\n// et ne marque la journée comme \"faite\" qu'en cas de succès.\nconst doneKey = msg._rebase_done_key;\nconst rebaseDay = msg._rebase_day;\nconst STORE = 'file';\nfunction cset(k,v){ try{ context.set(k, v, STORE);}catch(e){ context.set(k,v);} }\n\nif (msg.statusCode && msg.statusCode !== 200){\n  node.error(`HTTP ${msg.statusCode} sur gethomemeasure (rebase)`);\n  return null;\n}\n\nconst MAP = {\n  '3165697331':'sensor.conso_entree_hourly',\n  '3330257038':'sensor.conso_chambre_d_amis_hourly',\n  '2979072780':'sensor.conso_salle_de_bain_filles_hourly',\n  '3957213003':'sensor.conso_chambre_filles_hourly',\n  '3807033309':'sensor.conso_couloir_hourly',\n  '3864339241':'sensor.conso_toilettes_visiteurs_hourly',\n  '2064991252':'sensor.conso_salon_hourly',\n  '3761003540':'sensor.conso_salle_a_manger_hourly',\n  '3357075329':'sensor.conso_salle_de_bain_parents_hourly',\n  '1668330398':'sensor.conso_cuisine_hourly',\n  '1707740468':'sensor.conso_chambre_parents_hourly'\n};\n\nconst rooms = msg.payload?.body?.home?.rooms || [];\nif (!rooms.length) { node.warn(\"Rebase: pas de rooms dans la réponse Intuis\"); return null; }\n\nconst base = Object.assign({}, global.get('base_kwh') || {});\nfor (const r of rooms) {\n  const sensor = MAP[r.id]; if (!sensor) continue;\n  const m = r?.measures?.[0];\n  const wh = (m && Array.isArray(m.value) && m.value[0] && isFinite(+m.value[0][0])) ? (+m.value[0][0]) : 0;\n  const addKwh = wh / 1000;\n  const cur = Number(base[sensor]) || 0;\n  base[sensor] = Number((cur + addKwh).toFixed(3));  // devient EOD J-2\n}\n\nglobal.set('base_kwh', base);\nif (doneKey) cset(doneKey, true);\n\nmsg.payload = { rebased: true, day: rebaseDay, base_kwh: base };\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1050,
        "y": 960,
        "wires": [
            [
                "a70f6a2cedc558d6"
            ]
        ]
    },
    {
        "id": "a70f6a2cedc558d6",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "g": "40bddeefa0656431",
        "name": "Rebase J-2 → base_kwh (aperçu)",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 1260,
        "y": 1040,
        "wires": []
    },
    {
        "id": "4bbff6f268941713",
        "type": "inject",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "Importer HIER (manuel)",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 1280,
        "wires": [
            [
                "7af8f556aac0a82d"
            ]
        ]
    },
    {
        "id": "7af8f556aac0a82d",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "Set Authorization header",
        "func": "// Récupère le token Intuis depuis global et prépare msg.token (Bearer ...)\nconst t = global.get('AccessToken') || global.get('token');\nif (!t) {\n  node.error('Token Intuis introuvable dans global.intuis_token / global.token');\n  return null;\n}\nmsg.token = t.startsWith('Bearer ') ? t : `Bearer ${t}`;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 1280,
        "wires": [
            [
                "cb27cc16c7c43afc"
            ]
        ]
    },
    {
        "id": "cb27cc16c7c43afc",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "Fenêtre J-1 00:00 → 23:59:59 (local)",
        "func": "// Fenêtre J-1 : [hier 00:00 local, aujourd'hui 00:00 local)\n// => en UTC ça donnera p.ex. 03/10 22:00 → 04/10 22:00 si offset = +02:00\n\nconst d0 = new Date();        // maintenant (local)\nd0.setHours(0, 0, 0, 0);      // aujourd'hui 00:00 local\n\nconst end = new Date(d0);     // borne haute exclusive = aujourd'hui 00:00 local\nconst begin = new Date(d0);   // borne basse inclusive = hier 00:00 local\nbegin.setDate(begin.getDate() - 1);\n\nmsg.date_begin = Math.floor(begin.getTime() / 1000); // epoch sec (UTC)\nmsg.date_end = Math.floor(end.getTime() / 1000); // epoch sec (UTC)\n\n// (Optionnel) Aperçu pour vérifier\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `UTC ${new Date(msg.date_begin * 1000).toISOString()} → ${new Date(msg.date_end * 1000).toISOString()}`\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 830,
        "y": 1280,
        "wires": [
            [
                "1f2860ad572e43c5"
            ]
        ]
    },
    {
        "id": "1f2860ad572e43c5",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "Build payload Intuis (J-1, 1h)",
        "func": "// Build payload: jour courant 00:00 -> maintenant, échelle 1h\nconst home_id = $globalContext('home_id') || $globalContext('home_id'); // ton home_id\nconst router_id = $globalContext('routeur_id'); // ton bridge\n\nconst room_ids = [\n  $globalContext('room0_id'), // Entrée\n  $globalContext('room1_id'), // Chambre D’amis\n  $globalContext('room2_id'), // Salle De Bain Filles\n  $globalContext('room3_id'), // Chambre Filles\n  $globalContext('room4_id'), // Couloir\n  $globalContext('room5_id'), // Toilettes Visiteurs\n  $globalContext('room6_id'), // Salon\n  $globalContext('room7_id'), // Salle à manger\n  $globalContext('room8_id'), // Salle De Bain Parents\n  $globalContext('room9_id'), // Cuisine\n  $globalContext('room10_id')  // Chambre Parents\n];\n\nconst rooms = room_ids.map(id => ({ id, bridge: router_id, type: \"sum_energy_elec$0\" }));\n\nconst now = new Date();\nconst begin = new Date(now);\nbegin.setHours(0, 0, 0, 0); // 00:00 local\n\n// >>>>>>>>>>>> AUTH depuis global.AccessToken\nlet tok = global.get('AccessToken');\nif (!tok || typeof tok !== 'string' || !tok.trim()) {\n  node.error(\"Token Intuis introuvable (global.AccessToken)\", msg);\n  return null;\n}\ntok = /^Bearer\\s/i.test(tok) ? tok : (\"Bearer \" + tok);\nmsg.token = tok;\n// <<<<<<<<<<<<<<<\n\nmsg.payload = {\n  date_begin: msg.date_begin,\n  date_end:   msg.date_end,\n  scale: \"1hour\",\n  app_identifier: \"app_muller\",\n  home: { id: home_id, rooms }\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1170,
        "y": 1280,
        "wires": [
            [
                "beccb7f9fcad1b6b"
            ]
        ]
    },
    {
        "id": "beccb7f9fcad1b6b",
        "type": "http request",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "Intuis gethomemeasure (J-1, 1h)",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/gethomemeasure",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1490,
        "y": 1280,
        "wires": [
            [
                "b334d5e806aed874",
                "c1151738ca0c8042"
            ]
        ]
    },
    {
        "id": "b334d5e806aed874",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "Build payload import (hier, hourly, sum cumulée)",
        "func": "// Construit msg.payload pour recorder.import_statistics (un msg par capteur)\n// Base = global.base_kwh[statistic_id] (somme fin d'avant-hier)\n\nconst MAP = {\n  '3165697331':'sensor.conso_entree_hourly',\n  '3330257038':'sensor.conso_chambre_d_amis_hourly',\n  '2979072780':'sensor.conso_salle_de_bain_filles_hourly',\n  '3957213003':'sensor.conso_chambre_filles_hourly',\n  '1707740468':'sensor.conso_chambre_parents_hourly',\n  '3807033309':'sensor.conso_couloir_hourly',\n  '1668330398':'sensor.conso_cuisine_hourly',\n  '3761003540':'sensor.conso_salle_a_manger_hourly',\n  '3357075329':'sensor.conso_salle_de_bain_parents_hourly',\n  '2064991252':'sensor.conso_salon_hourly',\n  '3864339241':'sensor.conso_toilettes_visiteurs_hourly'\n};\n\nconst base = global.get('base_kwh') || {};\nconst rooms = msg.payload?.body?.home?.rooms || [];\nif (!rooms.length) { node.warn('Aucune room Intuis'); return [null, {payload:'Aucun capteur'}]; }\n\nconst outMsgs = [];\nconst previews = [];\nfor (const r of rooms){\n  const statId = MAP[r.id];\n  if (!statId) continue;\n  const m = r?.measures?.[0];\n  const values = m?.value || [];\n  if (!values.length) continue;\n\n  const step = m.step_time || 3600;\n  const edge0 = (m.beg_time - (m.step_time||3600)/2);  // epoch sec H:00 UTC-like\n\n  let cum = Number(base[statId]) || 0;  // kWh\n  const stats = [];\n  for (let i=0;i<values.length;i++){\n    let wh = values[i] && Number(values[i][0]);\n    if (!Number.isFinite(wh)) wh = 0;\n    cum += wh/1000;\n    const startIso = new Date((edge0 + i*step)*1000).toISOString();\n    const v = Number(cum.toFixed(3));\n    stats.push({ start: startIso, sum: v, state: v });\n  }\n\n  outMsgs.push({\n    payload: {\n      has_mean: false,\n      has_sum: true,\n      source: \"recorder\",\n      unit_of_measurement: \"kWh\",\n      statistic_id: statId,\n      stats\n    }\n  });\n\n  if (stats.length){\n    previews.push({\n      sensor: statId,\n      count: stats.length,\n      first: stats[0].start,\n      last: stats[stats.length-1].start\n    });\n  }\n}\n\nreturn [outMsgs, { payload: previews }];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 1360,
        "wires": [
            [
                "a74c44a9d300b9e4"
            ],
            [
                "1b30ae933cf1de32"
            ]
        ]
    },
    {
        "id": "a74c44a9d300b9e4",
        "type": "api-call-service",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "HA → recorder.import_statistics",
        "server": "553a4a33f70c2e19",
        "version": 7,
        "debugenabled": false,
        "action": "recorder.import_statistics",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "$$.payload",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "recorder",
        "service": "import_statistics",
        "x": 710,
        "y": 1360,
        "wires": [
            [
                "ee27abf3194d50c8"
            ]
        ]
    },
    {
        "id": "1b30ae933cf1de32",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "Aperçu import (id + nb + bornes)",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 690,
        "y": 1420,
        "wires": []
    },
    {
        "id": "c1151738ca0c8042",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "function 5",
        "func": "// Build payload d’import J-1 SANS toucher à base_kwh\nconst MAP = {\n  '3165697331': { id:'sensor.conso_entree_hourly' },\n  '3330257038': { id:'sensor.conso_chambre_d_amis_hourly' },\n  '2979072780': { id:'sensor.conso_salle_de_bain_filles_hourly' },\n  '3957213003': { id:'sensor.conso_chambre_filles_hourly' },\n  '3807033309': { id:'sensor.conso_couloir_hourly' },\n  '3864339241': { id:'sensor.conso_toilettes_visiteurs_hourly' },\n  '2064991252': { id:'sensor.conso_salon_hourly' },\n  '3761003540': { id:'sensor.conso_salle_a_manger_hourly' },\n  '3357075329': { id:'sensor.conso_salle_de_bain_parents_hourly' },\n  '1668330398': { id:'sensor.conso_cuisine_hourly' },\n  '1707740468': { id:'sensor.conso_chambre_parents_hourly' }\n};\n\nconst baseAll = global.get('base_kwh') || {}; // DOIT contenir la somme \"avant-hier soir\"\nconst rooms = msg.payload?.body?.home?.rooms || [];\nif (!rooms.length) { node.warn('Pas de rooms'); return null; }\n\nconst outMsgs = [];\nconst totalsYday = {}; // total J-1 par sensor (kWh) pour le commit après import\n\nfor (const r of rooms){\n  const meta = MAP[r.id]; if (!meta) continue;\n  const statId = meta.id;\n  const base = Number(baseAll[statId]) || 0; // somme d'AVANT-HIER soir (baseline pour importer J-1)\n\n  const m = r?.measures?.[0];\n  const vals = Array.isArray(m?.value) ? m.value : [];\n  if (!vals.length) continue;\n\n  const step = m.step_time || 3600;\n  const edge0 = (m.beg_time - step/2) * 1000; // début du 1er créneau (ms)\n\n  let runKwh = 0;\n  const stats = [];\n  for (let i=0;i<vals.length;i++){\n    const v = Array.isArray(vals[i]) ? vals[i][0] : undefined;\n    const n = (typeof v === 'number' && Number.isFinite(v)) ? v\n            : (typeof v === 'string' && v.trim()!=='' && Number.isFinite(+v)) ? +v\n            : NaN;\n    if (!Number.isFinite(n)) continue;\n\n    runKwh += n/1000; // cumul J-1\n    const startISO = new Date(edge0 + i*step*1000).toISOString();\n    const sum = Number((base + runKwh).toFixed(3));\n\n    // IMPORTANT: envoyer sum + state\n    stats.push({ start: startISO, sum: sum, state: sum });\n  }\n\n  if (!stats.length) continue;\n\n  // total J-1 pour ce sensor (servira à \"avancer\" la baseline après import réussi)\n  totalsYday[statId] = Number((runKwh).toFixed(3));\n\n  outMsgs.push({\n    payload: {\n      has_mean: false,\n      has_sum: true,\n      statistic_id: statId,\n      source: \"recorder\",\n      unit_of_measurement: \"kWh\",\n      stats\n    },\n    _preview: { sensor: statId, count: stats.length, first: stats[0].start, last: stats[stats.length-1].start }\n  });\n}\n\n// stocke les totaux J-1 pour le commit (au niveau flow)\nflow.set('pending_commit_yday', totalsYday);\n\nif (!outMsgs.length){ node.status({fill:\"green\",shape:\"dot\",text:\"rien à importer\"}); return null; }\nreturn [ outMsgs ];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 1420,
        "wires": [
            []
        ]
    },
    {
        "id": "ee27abf3194d50c8",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "55eac72b576d889c",
        "name": "function 6",
        "func": "// Commit baseline -> passe de \"avant-hier soir\" à \"hier soir\"\nconst res = msg.payload;\nif (res && res.error) {\n  node.warn(\"Import HA a renvoyé une erreur -> pas de commit baseline\");\n  return null;\n}\n\nconst totals = flow.get('pending_commit_yday') || {};\nconst base = { ...(global.get('base_kwh') || {}) };\n\nfor (const [sensor, inc] of Object.entries(totals)) {\n  const b = Number(base[sensor]) || 0;\n  base[sensor] = Number((b + (Number(inc)||0)).toFixed(3));\n}\n\nglobal.set('base_kwh', base);\nflow.set('pending_commit_yday', null);\n\nmsg.payload = { committed: totals, new_base_kwh: base };\nnode.status({fill:\"green\", shape:\"dot\", text:`baseline avancée (${Object.keys(totals).length} capteurs)`});\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 1380,
        "wires": [
            []
        ]
    },
    {
        "id": "a3bfae63e6e3a328",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Dernier sum → msg.topic + msg.payload (state)",
        "func": "const items = Array.isArray(msg.payload) ? msg.payload : [msg.payload];\nconst out = [];\nfor (const it of items) {\n  if (!it || !it.statistic_id || !Array.isArray(it.stats) || !it.stats.length) continue;\n  const last = it.stats[it.stats.length - 1];\n  const val  = Number(last && last.sum);\n  if (!Number.isFinite(val)) continue;\n  out.push({ topic: it.statistic_id, payload: val });\n}\nif (!out.length) return null;\nreturn [ out ];\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2240,
        "y": 820,
        "wires": [
            [
                "51c63c957e5b6382"
            ]
        ]
    },
    {
        "id": "51c63c957e5b6382",
        "type": "switch",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Route par statistic_id",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "sensor.conso_entree_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_chambre_d_amis_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_salle_de_bain_filles_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_chambre_filles_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_couloir_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_toilettes_visiteurs_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_salon_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_salle_a_manger_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_salle_de_bain_parents_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_cuisine_hourly",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sensor.conso_chambre_parents_hourly",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 11,
        "x": 2550,
        "y": 820,
        "wires": [
            [
                "d056028a766cc903"
            ],
            [
                "bccac2dad26af4b3"
            ],
            [
                "9089c50caeda28e0"
            ],
            [
                "0bde458557485ee7"
            ],
            [
                "f770f934e3b2947a"
            ],
            [
                "7c53f51b7e72b35e"
            ],
            [
                "6020d2b5c5a7f91c"
            ],
            [
                "8a750d7ac05a60a3"
            ],
            [
                "bbeb5e685d16d7f2"
            ],
            [
                "204f710424894214"
            ],
            [
                "574667cf5ab773a7"
            ]
        ]
    },
    {
        "id": "d056028a766cc903",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Entrée Hourly (state)",
        "entityConfig": "cfg0001aaaaaaa1a",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2900,
        "y": 680,
        "wires": [
            [
                "10a1ca1857c7f5b2"
            ]
        ]
    },
    {
        "id": "bccac2dad26af4b3",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Chambre d'amis Hourly (state)",
        "entityConfig": "cfg0002bbbbbbb2b",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2930,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "9089c50caeda28e0",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso SDB Filles Hourly (state)",
        "entityConfig": "cfg0003ccccccc3c",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2910,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "0bde458557485ee7",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Chambre Filles Hourly (state)",
        "entityConfig": "cfg0004ddddddd4d",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2930,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "f770f934e3b2947a",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Couloir Hourly (state)",
        "entityConfig": "cfg0005eeeeeee5e",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2900,
        "y": 860,
        "wires": [
            []
        ]
    },
    {
        "id": "7c53f51b7e72b35e",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso WC Visiteurs Hourly (state)",
        "entityConfig": "cfg0006ffffff6f6",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2920,
        "y": 900,
        "wires": [
            []
        ]
    },
    {
        "id": "6020d2b5c5a7f91c",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Salon Hourly (state)",
        "entityConfig": "cfg0007aaa1117a1",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2900,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "8a750d7ac05a60a3",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Salle à manger Hourly (state)",
        "entityConfig": "cfg0008bbb2228b2",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2930,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "bbeb5e685d16d7f2",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso SDB Parents Hourly (state)",
        "entityConfig": "cfg0009ccc3339c3",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2920,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "204f710424894214",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Cuisine Hourly (state)",
        "entityConfig": "cfg000addd444ad4",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2900,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "574667cf5ab773a7",
        "type": "ha-sensor",
        "z": "e9fafc919bcb1bb0",
        "g": "e0f310ef645539ec",
        "name": "Conso Chambre Parents Hourly (state)",
        "entityConfig": "cfg000beee555be5",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 2930,
        "y": 1120,
        "wires": [
            []
        ]
    },
    {
        "id": "58e4942428fac3f3",
        "type": "change",
        "z": "e9fafc919bcb1bb0",
        "name": "TZ = Europe/Paris",
        "rules": [
            {
                "t": "set",
                "p": "tz",
                "pt": "global",
                "to": "Europe/Paris",
                "tot": "str"
            }
        ],
        "x": 150,
        "y": 660,
        "wires": [
            [
                "2d704099afdb7720",
                "69d019898bb13801"
            ]
        ]
    },
    {
        "id": "e5e490820ebad235",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "40bddeefa0656431",
        "name": "Build gethomemeasure (J-3 → J-2) 1day (TZ local)",
        "func": "// J-2 00:00 → J-1 00:00 (jour complet J-2), scale 1day\nconst home_id =global.get('home_id');\nconst bridge  =global.get('routeur_id');\nconst token   = global.get('AccessToken') || global.get('intuis_token') || global.get('token');\nif (!token) { node.error(\"AccessToken/Token Intuis introuvable\"); return null; }\nmsg.token = token.startsWith('Bearer ') ? token : `Bearer ${token}`;\n\nconst room_ids = [\n global.get('room0_id'),global.get('room1_id'),global.get('room2_id'),global.get('room3_id'),global.get('room4_id'),\n global.get('room5_id'),global.get('room6_id'),global.get('room7_id'),global.get('room8_id'),global.get('room9_id'),global.get('room10_id')\n];\n\n// === bornes locales Europe/Paris ===\nconst tz = \"Europe/Paris\";\nconst nowLocal   = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));\nconst todayMid   = new Date(nowLocal); todayMid.setHours(0,0,0,0);        // J 00:00 local\nconst j1MidLocal = new Date(todayMid); j1MidLocal.setDate(j1MidLocal.getDate()-1); // J-1 00:00\nconst j2MidLocal = new Date(todayMid); j2MidLocal.setDate(j2MidLocal.getDate()-2); // J-2 00:00\n\nmsg.payload = {\n  date_begin: Math.floor(j2MidLocal.getTime()/1000),\n  date_end:   Math.floor(j1MidLocal.getTime()/1000),\n  scale: \"1day\",\n  app_identifier: \"app_muller\",\n  home: { id: home_id, rooms: room_ids.map(id => ({ id, bridge, type: \"sum_energy_elec$0\" })) }\n};\n\n// debug lisible\nmsg._window_debug = {\n  tz,\n  j2_local: j2MidLocal.toLocaleString('fr-FR', { timeZone: tz }),\n  j1_local: j1MidLocal.toLocaleString('fr-FR', { timeZone: tz }),\n  j2_iso: j2MidLocal.toISOString(),\n  j1_iso: j1MidLocal.toISOString()\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 940,
        "wires": [
            [
                "ecccbe1b2a1afe90"
            ]
        ]
    },
    {
        "id": "7d06561d83d9ae30",
        "type": "inject",
        "z": "e9fafc919bcb1bb0",
        "g": "76bcd7558fa413aa",
        "name": "Lancer maintenant",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 190,
        "y": 600,
        "wires": [
            [
                "7bfdf6abc3c6f4a4"
            ]
        ]
    },
    {
        "id": "7bfdf6abc3c6f4a4",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "76bcd7558fa413aa",
        "name": "Build gethomemeasure (16/08 → 06/10 inclus)",
        "func": "// Fenêtre fixe: 16 août 2025 00:00 → 7 oct 2025 00:00 (inclut le 6/10 complet)\n// Utilise l'échelle 1day pour obtenir 1 valeur Wh/jour/room puis on cumulera côté Node-RED.\n\nconst home_id = global.get('home_id');\nconst bridge  = global.get('routeur_id');\nconst room_ids = [\n  global.get('room0_id'),global.get('room1_id'),global.get('room2_id'),global.get('room3_id'),global.get('room4_id'),\n  global.get('room5_id'),global.get('room6_id'),global.get('room7_id'),global.get('room8_id'),global.get('room9_id'),global.get('room10_id')\n];\n\n// --- TOKEN ---\nconst rawToken = global.get('AccessToken') || global.get('intuis_token') || global.get('token');\nif (!rawToken) { node.error(\"Token Intuis introuvable dans global.AccessToken / global.intuis_token / global.token\"); return null; }\nmsg.token = rawToken.startsWith('Bearer ') ? rawToken : `Bearer ${rawToken}`;\n// -------------\n\n// Le conteneur est en Europe/Paris → on peut créer des Date locales:\n// JS: mois 0-indexé (août = 7, octobre = 9)\nconst startLocal = new Date(2025, 7, 16, 0, 0, 0, 0); // 16/08/2025 00:00 local\nconst endLocal   = new Date(2025, 9, 7,  0, 0, 0, 0); // 07/10/2025 00:00 local (exclu) ⇒ inclut 06/10 entier\n\nmsg.payload = {\n  date_begin: Math.floor(startLocal.getTime()/1000),\n  date_end:   Math.floor(endLocal.getTime()/1000),\n  scale: \"1day\",\n  app_identifier: \"app_muller\",\n  home: { id: home_id, rooms: room_ids.map(id => ({ id, bridge, type: \"sum_energy_elec$0\" })) }\n};\n\n// Pour info dans la suite\nmsg._period = { from: \"2025-08-16\", to: \"2025-10-06\" };\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 600,
        "wires": [
            [
                "2c7d7e6bd284cb92",
                "a5eeb1e998b414c3"
            ]
        ]
    },
    {
        "id": "2c7d7e6bd284cb92",
        "type": "http request",
        "z": "e9fafc919bcb1bb0",
        "g": "76bcd7558fa413aa",
        "name": "Intuis gethomemeasure (1day, range)",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/gethomemeasure",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 870,
        "y": 600,
        "wires": [
            [
                "e175a6bd52325a35"
            ]
        ]
    },
    {
        "id": "e175a6bd52325a35",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "76bcd7558fa413aa",
        "name": "Somme kWh par radiateur (format rebase_kwh)",
        "func": "// Agrège toutes les valeurs 1day (Wh) par room → kWh par sensor.\n// Sortie en debug: { base_kwh: { sensor_id: kWh, ... }, from, to }\n\nconst MAP = {\n  '3165697331':'sensor.conso_entree_hourly',\n  '3330257038':'sensor.conso_chambre_d_amis_hourly',\n  '2979072780':'sensor.conso_salle_de_bain_filles_hourly',\n  '3957213003':'sensor.conso_chambre_filles_hourly',\n  '3807033309':'sensor.conso_couloir_hourly',\n  '3864339241':'sensor.conso_toilettes_visiteurs_hourly',\n  '2064991252':'sensor.conso_salon_hourly',\n  '3761003540':'sensor.conso_salle_a_manger_hourly',\n  '3357075329':'sensor.conso_salle_de_bain_parents_hourly',\n  '1668330398':'sensor.conso_cuisine_hourly',\n  '1707740468':'sensor.conso_chambre_parents_hourly'\n};\n\nif (msg.statusCode && msg.statusCode !== 200){\n  node.error(`HTTP ${msg.statusCode} sur gethomemeasure (1day, range)`);\n  return null;\n}\n\nconst rooms = msg.payload?.body?.home?.rooms || [];\nif (!rooms.length) { node.warn('Pas de rooms dans la réponse Intuis'); return null; }\n\nconst totals = {}; // sensor_id -> kWh\nfor (const r of rooms){\n  const sensor = MAP[r.id];\n  if (!sensor) continue;\n  let wh = 0;\n  const measures = Array.isArray(r.measures) ? r.measures : [];\n  for (const m of measures){\n    const arr = Array.isArray(m.value) ? m.value : [];\n    for (const row of arr){\n      const v = Array.isArray(row) ? row[0] : row;\n      const num = (typeof v === 'number' && Number.isFinite(v)) ? v\n                : (typeof v === 'string' && v.trim()!=='' && Number.isFinite(+v)) ? +v\n                : NaN;\n      if (Number.isFinite(num)) wh += num; // Wh\n    }\n  }\n  totals[sensor] = Number((wh/1000).toFixed(3)); // kWh\n}\n\nmsg.payload = {\n  from: msg._period?.from || null,\n  to:   msg._period?.to   || null,\n  base_kwh: totals\n};\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 500,
        "wires": [
            [
                "0f6f05ef24faae01",
                "e1f0bcc5f0064327"
            ]
        ]
    },
    {
        "id": "0f6f05ef24faae01",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "g": "76bcd7558fa413aa",
        "name": "Bilan période (format rebase_kwh)",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 1540,
        "y": 500,
        "wires": []
    },
    {
        "id": "e1f0bcc5f0064327",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "d": true,
        "g": "76bcd7558fa413aa",
        "name": "Rebase base_kwh (MODE SET)",
        "func": "const totals = msg?.payload?.base_kwh;\nif (!totals || typeof totals !== 'object') {\n  node.warn('Rebase SET: payload.base_kwh manquant');\n  return null;\n}\n\nconst r3 = (x) => Number((Number(x)||0).toFixed(3));\n\n// état actuel\nconst before = Object.assign({}, global.get('base_kwh') || {});\n\n// after = on REMPLACE par les valeurs fournies (SET)\nconst after = {};\nfor (const [sensor, val] of Object.entries(totals)) {\n  after[sensor] = r3(val);\n}\n\n// delta = after - before (pour contrôle)\nconst delta = {};\nconst keys = new Set([...Object.keys(before), ...Object.keys(after)]);\nfor (const k of keys) {\n  delta[k] = r3((Number(after[k])||0) - (Number(before[k])||0));\n}\n\n// commit\nglobal.set('base_kwh', after);\n\nmsg.payload = {\n  rebase_applied: true,\n  mode: 'set',\n  from: msg._period?.from || null,\n  to:   msg._period?.to   || null,\n  before,\n  set_values: after,\n  delta,\n  after\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1490,
        "y": 560,
        "wires": [
            [
                "c9cad622fe8d90c7"
            ]
        ]
    },
    {
        "id": "c9cad622fe8d90c7",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "g": "76bcd7558fa413aa",
        "name": "Rebase SET → aperçu (before / set_values / delta / after)",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 1540,
        "y": 620,
        "wires": []
    },
    {
        "id": "e4176ff1f4d664e9",
        "type": "function",
        "z": "e9fafc919bcb1bb0",
        "g": "40bddeefa0656431",
        "name": "Run once today (lock)",
        "func": "const tz = global.get('tz') || \"Europe/Paris\";\nconst STORE = 'file';\nfunction cget(k){ try{ return context.get(k, STORE);}catch(e){return context.get(k);} }\nfunction cset(k,v){ try{ context.set(k, v, STORE);}catch(e){ context.set(k,v);} }\n\n// date du jour (locale)\nconst nowLocal = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));\nconst todayStr = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' }).format(nowLocal);\nconst lockKey  = `rebase_run_today_${todayStr}`;\n\n// si déjà exécuté aujourd'hui (sauf override)\nif (!msg.force && cget(lockKey)){\n  node.status({ fill:'green', shape:'ring', text:`Déjà exécuté aujourd'hui (${todayStr})` });\n  return null;\n}\n\n// pose le verrou du jour et continue\ncset(lockKey, true);\nmsg._run_today_key = lockKey;\nmsg._run_today_str = todayStr;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 160,
        "y": 1060,
        "wires": [
            [
                "69d019898bb13801"
            ]
        ]
    },
    {
        "id": "a5eeb1e998b414c3",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "g": "76bcd7558fa413aa",
        "name": "debug 7",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 780,
        "y": 500,
        "wires": []
    },
    {
        "id": "10a1ca1857c7f5b2",
        "type": "debug",
        "z": "e9fafc919bcb1bb0",
        "name": "debug 9",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3140,
        "y": 680,
        "wires": []
    },
    {
        "id": "2284f3734545b917",
        "type": "debug",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "contrôle retour",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1720,
        "y": 360,
        "wires": []
    },
    {
        "id": "291def603d112901",
        "type": "debug",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "contrôle requête",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1560,
        "y": 200,
        "wires": []
    },
    {
        "id": "8dbef555eed4361a",
        "type": "http request",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "Intuis setstate",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/syncapi/v1/setstate",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1540,
        "y": 380,
        "wires": [
            [
                "2284f3734545b917"
            ]
        ]
    },
    {
        "id": "2dce5e6356438427",
        "type": "change",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "Set param acquit fenetre",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t    \"home\": {\t        \"id\": $globalContext(\"home_id\"),\t        \"rooms\": [\t            {\t                \"id\": $globalContext(\"last_room_name_to_id\"),\t                \"therm_setpoint_mode\": $globalContext(\"heater_mode_setpoint\"),\t                \"therm_setpoint_temperature\": $globalContext(\"temp_setpoint\"),\t                \"therm_setpoint_end_time\": $globalContext(\"due_date_setpoint\")\t            }\t        ]\t    }\t}\t\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1370,
        "y": 280,
        "wires": [
            [
                "291def603d112901",
                "8dbef555eed4361a"
            ]
        ]
    },
    {
        "id": "6d5d3571be5633fd",
        "type": "change",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "token",
                "pt": "msg",
                "to": "\"Bearer \" & $globalContext(\"AccessToken\")\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1150,
        "y": 280,
        "wires": [
            [
                "2dce5e6356438427"
            ]
        ]
    },
    {
        "id": "7af3acb374f2f8df",
        "type": "server-state-changed",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "Mode de fonctionnement - setpoint",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.radiateur_intuis_set_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 180,
        "y": 280,
        "wires": [
            [
                "7fa446ca2816755a"
            ]
        ]
    },
    {
        "id": "c69b09baaa192488",
        "type": "server-state-changed",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "Consigne de température - setpoint",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.radiateur_chambre_parents_consigne_de_temperature_setpoint"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 180,
        "y": 220,
        "wires": [
            [
                "016343b39a2a28ab"
            ]
        ]
    },
    {
        "id": "016343b39a2a28ab",
        "type": "change",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "temp_setpoint",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 220,
        "wires": [
            [
                "eba27c296525a892"
            ]
        ]
    },
    {
        "id": "8e6f7b77b1eb54af",
        "type": "change",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "due_date_setpoint",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 340,
        "wires": [
            [
                "eba27c296525a892"
            ]
        ]
    },
    {
        "id": "ec71b21f5bc9c093",
        "type": "change",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "heater_mode_setpoint",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 280,
        "wires": [
            [
                "eba27c296525a892"
            ]
        ]
    },
    {
        "id": "eba27c296525a892",
        "type": "delay",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 960,
        "y": 280,
        "wires": [
            [
                "6d5d3571be5633fd"
            ]
        ]
    },
    {
        "id": "6af3d466047f7a52",
        "type": "server-state-changed",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "Echéance - setpoint",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_datetime.radiateur_setpoint_end_time"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 130,
        "y": 340,
        "wires": [
            [
                "5c8f4bcc2837e168"
            ]
        ]
    },
    {
        "id": "a29b863ea3041d60",
        "type": "change",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "(\t  $now := $round($millis()/1000,0);\t  $payload := $round($toMillis(payload)/1000,0);\t  $nowPlus1min := $now + 60;\t  $nowPlus3h := $now + 3*3600;\t  ($payload = null or $payload < $nowPlus1min) ? $nowPlus3h : $payload\t)\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 550,
        "y": 340,
        "wires": [
            [
                "8e6f7b77b1eb54af"
            ]
        ]
    },
    {
        "id": "5c8f4bcc2837e168",
        "type": "moment",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "topic": "",
        "input": "payload",
        "inputType": "msg",
        "inTz": "Europe/Paris",
        "adjAmount": 0,
        "adjType": "days",
        "adjDir": "add",
        "format": "",
        "locale": "C",
        "output": "payload",
        "outputType": "msg",
        "outTz": "Europe/Paris",
        "x": 340,
        "y": 340,
        "wires": [
            [
                "a29b863ea3041d60"
            ]
        ]
    },
    {
        "id": "b768431bdc70ed26",
        "type": "server-state-changed",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "Ecoute Choix pièce",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "select.choix_de_la_piece"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "entity",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 130,
        "y": 400,
        "wires": [
            [
                "98cc6cd141f417dd"
            ]
        ]
    },
    {
        "id": "98cc6cd141f417dd",
        "type": "function",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "function 2",
        "func": "let selectedRoomName = msg.payload;  // par défaut c'est juste le nom de la pièce sélectionnée\nlet map = global.get(\"room_name_to_id\") || {};\n\nlet roomId = map[selectedRoomName];\n\nif (!roomId) {\n    node.warn(`Nom de pièce non trouvé dans la map: ${selectedRoomName}`);\n    return null;\n}\n\nmsg.payload = roomId;  // l'ID de la pièce qu'on pourra utiliser ensuite\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 400,
        "wires": [
            [
                "d8231a77695dcab3",
                "aa78272c808be164"
            ]
        ]
    },
    {
        "id": "d8231a77695dcab3",
        "type": "debug",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "debug 2",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 480,
        "y": 480,
        "wires": []
    },
    {
        "id": "aa78272c808be164",
        "type": "change",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "last_room_name_to_id",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 590,
        "y": 400,
        "wires": [
            [
                "eba27c296525a892"
            ]
        ]
    },
    {
        "id": "7fa446ca2816755a",
        "type": "function",
        "z": "860dc5f127961a85",
        "g": "d73b70410efb22bb",
        "name": "Transco home mode",
        "func": "if(msg.payload == \"Home\")\n{\n    msg.payload = \"home\";\n}\nelse if ( msg.payload == \"Hors Gel\")\n{\n    msg.payload = \"hg\";\n}\nelse if ( msg.payload == \"Manuel\")\n{\n    msg.payload = \"manual\";\n}\nelse if ( msg.payload == \"Off\")\n{\n    msg.payload = \"off\";\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 280,
        "wires": [
            [
                "ec71b21f5bc9c093"
            ]
        ]
    },
    {
        "id": "70dd93a666dabb85",
        "type": "debug",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "contrôle retour Maison",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1920,
        "y": 140,
        "wires": []
    },
    {
        "id": "a020d0b832de0461",
        "type": "debug",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "contrôle requête Maison",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1720,
        "y": 80,
        "wires": []
    },
    {
        "id": "b370c200d67c72d0",
        "type": "http request",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "Intuis setstate",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/setthermmode",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1700,
        "y": 140,
        "wires": [
            [
                "70dd93a666dabb85"
            ]
        ]
    },
    {
        "id": "694eff9388e6ee0b",
        "type": "change",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "Set home mode",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t  \"app_identifier\": \"app_muller\",\t  \"home_id\": $globalContext(\"home_id\"),\t  \"mode\": $globalContext(\"mode_setpoint\"),\t  \"endtime\": $globalContext(\"due_date_setpoint\")\t}\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1500,
        "y": 140,
        "wires": [
            [
                "a020d0b832de0461",
                "b370c200d67c72d0"
            ]
        ]
    },
    {
        "id": "f401417910df9539",
        "type": "change",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "token",
                "pt": "msg",
                "to": "\"Bearer \" & $globalContext(\"AccessToken\")\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1290,
        "y": 140,
        "wires": [
            [
                "694eff9388e6ee0b"
            ]
        ]
    },
    {
        "id": "eb25f09353fdc7d3",
        "type": "server-state-changed",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "Home mode selected",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.radiateurs_intuis_set_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 140,
        "y": 140,
        "wires": [
            [
                "631269ebe3e11f3c"
            ]
        ]
    },
    {
        "id": "93940e1bce67c556",
        "type": "change",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "due_date_setpoint",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 200,
        "wires": [
            [
                "a5251ee538ed1710"
            ]
        ]
    },
    {
        "id": "a28d9e95cda9fb75",
        "type": "change",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "mode_setpoint",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 860,
        "y": 140,
        "wires": [
            [
                "137a2efc6997b839"
            ]
        ]
    },
    {
        "id": "137a2efc6997b839",
        "type": "delay",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "",
        "pauseType": "delay",
        "timeout": "100",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 1090,
        "y": 140,
        "wires": [
            [
                "f401417910df9539"
            ]
        ]
    },
    {
        "id": "af254d5733c8ef04",
        "type": "server-state-changed",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "Due date selected",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_datetime.away_until_date"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 130,
        "y": 200,
        "wires": [
            [
                "8046e791812a85ff"
            ]
        ]
    },
    {
        "id": "26a1b2a7070080d1",
        "type": "change",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$round($number($toMillis(payload))/1000,0)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 590,
        "y": 200,
        "wires": [
            [
                "93940e1bce67c556"
            ]
        ]
    },
    {
        "id": "8046e791812a85ff",
        "type": "moment",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "",
        "topic": "",
        "input": "payload",
        "inputType": "msg",
        "inTz": "Europe/Paris",
        "adjAmount": 0,
        "adjType": "days",
        "adjDir": "add",
        "format": "",
        "locale": "C",
        "output": "payload",
        "outputType": "msg",
        "outTz": "Europe/Paris",
        "x": 360,
        "y": 200,
        "wires": [
            [
                "26a1b2a7070080d1"
            ]
        ]
    },
    {
        "id": "631269ebe3e11f3c",
        "type": "function",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "Transco home mode",
        "func": "if(msg.payload == \"Home\")\n{\n    msg.payload = \"schedule\";\n}\nelse if (msg.payload == \"Away\")\n{\n    msg.payload = \"away\";\n}\nelse if ( msg.payload == \"Hors Gel\")\n{\n    msg.payload = \"hg\";\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 140,
        "wires": [
            [
                "a28d9e95cda9fb75"
            ]
        ]
    },
    {
        "id": "a5251ee538ed1710",
        "type": "function",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "Modifie endpoint à null si dans le passé",
        "func": "const endtime = global.get(\"due_date_setpoint\"); // timestamp attendu en secondes\n\nconst now = Math.floor(Date.now() / 1000);\nconst minTime = now + 5 * 60;\nconst maxTime = now + 365 * 24 * 60 * 60;\n\nlet validEndtime = null;\n\n// Vérifie si endtime est dans la plage valide\nif (endtime >= minTime && endtime <= maxTime) {\n    validEndtime = endtime;\n}\n\n// Si endtime est invalide ET le mode est \"manual\", alors on met une durée par défaut\nif (validEndtime === null && global.get(\"mode_setpoint\") === \"manual\") {\n    validEndtime = now + 60 * 60 * 3; // 3 heures à partir de maintenant\n}\nif (validEndtime === null && global.get(\"mode_setpoint\") === \"hg\") {\n    validEndtime = null; // 3 heures à partir de maintenant\n}\n// On met à jour la valeur globale avec la nouvelle valeur (valide ou fallback)\nglobal.set(\"due_date_setpoint\", validEndtime);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 200,
        "wires": [
            [
                "137a2efc6997b839",
                "20f1c4335ef651b8"
            ]
        ]
    },
    {
        "id": "0b868dcf7fcf7799",
        "type": "change",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "home_temp_setpoint",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 500,
        "y": 80,
        "wires": [
            [
                "137a2efc6997b839"
            ]
        ]
    },
    {
        "id": "eb93568756aae0c1",
        "type": "server-state-changed",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "Consigne de température - setpoint",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.radiateurs_consigne_de_temperature_setpoint"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 180,
        "y": 80,
        "wires": [
            [
                "0b868dcf7fcf7799"
            ]
        ]
    },
    {
        "id": "20f1c4335ef651b8",
        "type": "debug",
        "z": "a9b5c4b52d4c4353",
        "g": "584780eef1d73b39",
        "name": "debug 6",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1500,
        "y": 200,
        "wires": []
    },
    {
        "id": "db2e9700612e90c7",
        "type": "server-state-changed",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "Etat bouton acquitter ",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_button.ack_windows_open"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": true,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "1",
                "valueType": "num"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 150,
        "y": 420,
        "wires": [
            [
                "ac8b2b7fd8f8338b"
            ]
        ]
    },
    {
        "id": "ac8b2b7fd8f8338b",
        "type": "change",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "token",
                "pt": "msg",
                "to": "\"Bearer \" & $globalContext(\"AccessToken\")\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 420,
        "wires": [
            [
                "305e6eecdfcdbab8"
            ]
        ]
    },
    {
        "id": "305e6eecdfcdbab8",
        "type": "change",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "Set param acquit fenetre",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t  \"home\": {\t    \"id\": $globalContext(\"home_id\"),\t    \"rooms\": [\t      {\t        \"id\": $globalContext(\"room0_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room1_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room2_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room3_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room4_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room5_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room6_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room7_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room8_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room9_id\"),\t        \"open_window\": false\t      },\t      {\t        \"id\": $globalContext(\"room10_id\"),\t        \"open_window\": false\t      }\t    ]\t  },\t  \"app_identifier\": \"app_muller\"\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 420,
        "wires": [
            [
                "39764885d59f717f",
                "d557fa56bfd86784"
            ]
        ]
    },
    {
        "id": "bf7f6839c6704e59",
        "type": "debug",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "contrôle retour",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1340,
        "y": 420,
        "wires": []
    },
    {
        "id": "39764885d59f717f",
        "type": "debug",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "contrôle requête",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 360,
        "wires": []
    },
    {
        "id": "2659be5f29a72d6f",
        "type": "inject",
        "z": "01517d737b12772c",
        "d": true,
        "g": "f6858dc60a10d52d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 170,
        "y": 360,
        "wires": [
            [
                "ac8b2b7fd8f8338b"
            ]
        ]
    },
    {
        "id": "d557fa56bfd86784",
        "type": "http request",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "Intuis setstate",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/syncapi/v1/setstate",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1020,
        "y": 420,
        "wires": [
            [
                "bf7f6839c6704e59"
            ]
        ]
    },
    {
        "id": "5f2c7142749b5d0a",
        "type": "comment",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "A compléter ... ",
        "info": "Renseigner votre serveur\nPuis ajouter une entitée \nEn cliquant sur + add entity",
        "x": 170,
        "y": 480,
        "wires": []
    },
    {
        "id": "7e4ede2a32fcc1c8",
        "type": "comment",
        "z": "01517d737b12772c",
        "g": "f6858dc60a10d52d",
        "name": "A compléter selon nombre de pièces ",
        "info": "",
        "x": 740,
        "y": 460,
        "wires": []
    },
    {
        "id": "71d1d1dbf7e5a846",
        "type": "server-state-changed",
        "z": "01517d737b12772c",
        "g": "a8c552048ea1aa6a",
        "name": "Etat planning chauffage",
        "server": "553a4a33f70c2e19",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "select.liste_des_plannings_nr"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": true,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "seconds",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "1",
                "valueType": "num"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 160,
        "y": 160,
        "wires": [
            [
                "3e7607f0ba55c20c"
            ]
        ]
    },
    {
        "id": "3e7607f0ba55c20c",
        "type": "function",
        "z": "01517d737b12772c",
        "g": "a8c552048ea1aa6a",
        "name": "Nom -> Schedule ID",
        "func": "// Récupère le mapping global (nom -> id)\nlet planning_name_to_id = global.get(\"planning_name_to_id\") || {};\nlet selectedName = msg.data.new_state.state;\nif (!selectedName || !planning_name_to_id[selectedName]) {\n    node.warn(\"Nom de planning non trouvé: \" + selectedName);\n    return null;\n}\nlet schedule_id = planning_name_to_id[selectedName];\nmsg.payload = {\n    app_identifier: \"app_muller\",\n    home_id: global.get(\"home_id\"),\n    schedule_id: schedule_id,\n    schedule_type: \"therm\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 420,
        "y": 160,
        "wires": [
            [
                "970fe3350a767473"
            ]
        ]
    },
    {
        "id": "970fe3350a767473",
        "type": "change",
        "z": "01517d737b12772c",
        "g": "a8c552048ea1aa6a",
        "name": "Set token",
        "rules": [
            {
                "t": "set",
                "p": "token",
                "pt": "msg",
                "to": "\"Bearer \" & $globalContext(\"AccessToken\")",
                "tot": "jsonata"
            }
        ],
        "x": 640,
        "y": 160,
        "wires": [
            [
                "17f16f38597c8169"
            ]
        ]
    },
    {
        "id": "17f16f38597c8169",
        "type": "http request",
        "z": "01517d737b12772c",
        "g": "a8c552048ea1aa6a",
        "name": "Intuis switchhomeschedule",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/switchhomeschedule",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 860,
        "y": 160,
        "wires": [
            [
                "65fc4c1d577cc47b"
            ]
        ]
    },
    {
        "id": "65fc4c1d577cc47b",
        "type": "debug",
        "z": "01517d737b12772c",
        "g": "a8c552048ea1aa6a",
        "name": "contrôle requête Planning",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 160,
        "wires": []
    },
    {
        "id": "3981f06b9729fdd3",
        "type": "http request",
        "z": "8c2a949c276d4083",
        "name": "Intuis synchomeschedule",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/synchomeschedule",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1030,
        "y": 420,
        "wires": [
            [
                "e270250674abb790",
                "19f8fcc565a1a54f",
                "0c3fb66944351844"
            ]
        ]
    },
    {
        "id": "e270250674abb790",
        "type": "debug",
        "z": "8c2a949c276d4083",
        "name": "Retour Intuis",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1250,
        "y": 520,
        "wires": []
    },
    {
        "id": "3d404318ad30bb73",
        "type": "mqtt in",
        "z": "8c2a949c276d4083",
        "name": "MQTT IN principal",
        "topic": "plannings/+",
        "qos": "0",
        "datatype": "json",
        "broker": "b22e94a0f37cb076",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 110,
        "y": 340,
        "wires": [
            [
                "e881197b4bd9850e"
            ]
        ]
    },
    {
        "id": "f815252142abcab3",
        "type": "mqtt in",
        "z": "8c2a949c276d4083",
        "name": "MQTT IN /set",
        "topic": "plannings/+/set",
        "qos": "0",
        "datatype": "json",
        "broker": "b22e94a0f37cb076",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 90,
        "y": 420,
        "wires": [
            [
                "46cacba7c8be5293"
            ]
        ]
    },
    {
        "id": "46cacba7c8be5293",
        "type": "change",
        "z": "8c2a949c276d4083",
        "name": "Extrait schedule_id + get main",
        "rules": [
            {
                "t": "set",
                "p": "schedule_id",
                "pt": "msg",
                "to": "$match(topic, /^plannings\\/(therm_schedule_[^/]+)\\/set$/).groups[1]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "main",
                "pt": "msg",
                "to": "$flowContext('planning_' & schedule_id)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 350,
        "y": 420,
        "wires": [
            [
                "fd2e7302019dcaa1"
            ]
        ]
    },
    {
        "id": "fd2e7302019dcaa1",
        "type": "function",
        "z": "8c2a949c276d4083",
        "name": "Diff ? (si oui, prépare payload Intuis)",
        "func": "if (global.get('refreshing')) {\n    node.warn(\"En mode refresh global : pas de diff, pas d’envoi à Intuis\");\n    return null;\n}\n\n// Vérifie le topic /set reçu\nconst home_id = global.get(\"home_id\");\nconst accessToken = global.get(\"AccessToken\");\n//node.warn(\"MSG TOPIC: \" + msg.topic);\nlet m = msg.topic.match(/^plannings\\/(therm_schedule_[^\\/]+)\\/set$/);\nif (!m || !m[1]) {\n   // node.warn('Pas de match schedule_id');\n    return null;\n}\nlet schedule_id = m[1];\n\n// Va chercher le main depuis le contexte flow (déjà stocké par l’autre flow !)\nlet main = flow.get('planning_' + schedule_id);\nif (!main) {\n    //node.warn(\"Aucun planning principal en mémoire pour ce schedule_id\");\n    return null;\n}\n\nif (typeof main === \"string\") { try { main = JSON.parse(main); } catch {} }\nif (typeof msg.payload === \"string\") { try { msg.payload = JSON.parse(msg.payload); } catch {} }\n\n// Compare uniquement les parties importantes\nfunction relevant(obj) {\n    return {\n        timetable: obj.timetable,\n        zones: obj.zones,\n        away_temp: obj.away_temp,\n        hg_temp: obj.hg_temp\n    };\n}\nfunction planningname(obj1) {\n    return  {\n        name: obj1.name\n    }\n}\nlet oldname = planningname(main);\nlet old = relevant(main);\nlet now = relevant(msg.payload);\n\nif (JSON.stringify(old) === JSON.stringify(now)) {\n    // node.warn(\"Aucune différence, rien à envoyer à Intuis\");\n    return null;\n}\n\n// Si on arrive ici, il y a une vraie diff !\n// node.warn(\"DIFF détectée, envoi à Intuis !\");\nmsg.payload = {\n    app_identifier: \"app_muller\",\n    home_id: home_id,\n    schedule_id: schedule_id.replace(/^therm_schedule_/, \"\"),\n    name: oldname.name,\n    timetable: now.timetable,\n    zones: now.zones,\n    away_temp: now.away_temp,\n    hg_temp: now.hg_temp\n};\nmsg.token = \"Bearer \" + accessToken;\nmsg.schedule_id = schedule_id;\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 420,
        "wires": [
            [
                "1e0d532fc2a49b13",
                "3981f06b9729fdd3"
            ]
        ]
    },
    {
        "id": "1e0d532fc2a49b13",
        "type": "debug",
        "z": "8c2a949c276d4083",
        "name": "Diff debug",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 280,
        "wires": []
    },
    {
        "id": "3c6b7dee554169ec",
        "type": "debug",
        "z": "8c2a949c276d4083",
        "name": "debug 5",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1520,
        "y": 520,
        "wires": []
    },
    {
        "id": "605e4e9c9978e704",
        "type": "function",
        "z": "8c2a949c276d4083",
        "name": "Save main schedule",
        "func": "//node.warn(\"MSG TOPIC: \" + msg.topic); // Affiche le topic exact reçu\nif(msg.topic){\n    let m = msg.topic.match(/^plannings\\/(therm_schedule_[^/]+)$/);\n   // node.warn(\"REGEX: \" + JSON.stringify(m));\n    if(m && m[1]) {\n        msg.schedule_id = m[1];\n        flow.set('planning_' + msg.schedule_id, msg.payload);\n     //   node.warn('Stocké: planning_' + msg.schedule_id);\n    } else {\n        node.warn('Pas de match schedule_id');\n    }\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "19f8fcc565a1a54f",
        "type": "link out",
        "z": "8c2a949c276d4083",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "cc3714a460f5cecb"
        ],
        "x": 1195,
        "y": 340,
        "wires": []
    },
    {
        "id": "0c3fb66944351844",
        "type": "function",
        "z": "8c2a949c276d4083",
        "name": "Publier feedback planning",
        "func": "// Essaie de trouver le schedule_id à tous les endroits possibles\nlet planning_id =\n    msg.schedule_id ||\n    (msg.payload && msg.payload.schedule_id) ||\n    (msg.payload && msg.payload.body && msg.payload.body.schedule_id) ||\n    \"unk\";\n\n// Si l’API t’a renvoyé le planning avec id sans le \"therm_schedule_\" devant, ajoute-le ici si besoin\nif (!planning_id.startsWith(\"therm_schedule_\") && planning_id.length > 15) {\n    planning_id = \"therm_schedule_\" + planning_id;\n}\n\nconst topic = `plannings/result_${planning_id}`;\n\n// Statut = succès si le retour API a .success, sinon true par défaut (adapte à ta structure)\nlet status = true;\nlet apiMsg = \"\";\n\n// Vérifie s'il y a une erreur format Intuis\nif (typeof msg.payload === \"object\") {\n    // Cas API Intuis avec .error\n    if (msg.payload.error) {\n        status = false;\n        apiMsg = msg.payload.error.message || JSON.stringify(msg.payload.error);\n    }\n    // Cas success flag explicite\n    else if (msg.payload.success === false) {\n        status = false;\n        apiMsg = msg.payload.message || msg.payload.error || \"\";\n    } else if (typeof msg.payload.success === \"boolean\") {\n        status = !!msg.payload.success;\n        apiMsg = msg.payload.message || \"\";\n    }\n}\n\n// Option fallback si tu as d’autres flags d’erreur\nif (typeof msg.api_ok !== \"undefined\") status = !!msg.api_ok;\nif (typeof msg.api_err_msg === \"string\" && msg.api_err_msg) apiMsg = msg.api_err_msg;\n\nconst message = status\n    ? \"Planning injecté avec succès.\"\n    : \"Erreur : \" + (apiMsg || \"API inconnue\");\n\nreturn {\n    topic: topic,\n    payload: JSON.stringify({\n        ok: status,\n        message: message,\n        id: planning_id,\n        timestamp: Math.floor(Date.now() / 1000)\n    }),\n    retain: false\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1290,
        "y": 420,
        "wires": [
            [
                "188d9086690f1808",
                "3c6b7dee554169ec"
            ]
        ]
    },
    {
        "id": "188d9086690f1808",
        "type": "mqtt out",
        "z": "8c2a949c276d4083",
        "name": "MQTT publish feedback",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "b22e94a0f37cb076",
        "x": 1550,
        "y": 420,
        "wires": []
    },
    {
        "id": "e881197b4bd9850e",
        "type": "function",
        "z": "8c2a949c276d4083",
        "name": "Filtre les result_",
        "func": "// Node \"function\"\nif (msg.topic && msg.topic.startsWith(\"plannings/result_\")) {\n    // On ignore les messages de feedback\n    return null;\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 340,
        "wires": [
            [
                "605e4e9c9978e704"
            ]
        ]
    },
    {
        "id": "de739397b5b2dbaa",
        "type": "inject",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "Tester (J-94 → J-5)",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 190,
        "y": 60,
        "wires": [
            [
                "383fb030d0a0c1b8"
            ]
        ]
    },
    {
        "id": "383fb030d0a0c1b8",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "Fenêtre J-60 00:00 → J-10 23:59:59",
        "func": "const today = new Date();\ntoday.setHours(0,0,0,0);\nconst beginLocal = new Date(today.getTime() - 60*24*3600*1000);\nconst endLocal   = new Date(today.getTime() - 10*24*3600*1000 - 1000);\nmsg.date_begin = Math.floor(beginLocal.getTime()/1000);\nmsg.date_end   = Math.floor(endLocal.getTime()/1000);\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 90,
        "wires": [
            [
                "25869d436d13e5b0"
            ]
        ]
    },
    {
        "id": "e42b9ca63874ea93",
        "type": "http request",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "GET /api/homesdata",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/homesdata",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Authorization",
                "valueType": "msg",
                "valueValue": "token"
            }
        ],
        "x": 920,
        "y": 100,
        "wires": [
            [
                "6af3eda862574d9e",
                "02f6d7f621a64af3"
            ]
        ]
    },
    {
        "id": "6af3eda862574d9e",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "Build gethomemeasure (3hours)",
        "func": "const hd = msg.payload;\nconst home = hd && hd.body && Array.isArray(hd.body.homes) ? hd.body.homes[0] : null;\nif (!home) { node.error('homesdata inattendu: body.homes[0] manquant.', msg); return null; }\nconst homeId = home.id;\nconst nmgModule = Array.isArray(home.modules) ? home.modules.find(m => m.type === 'NMG') : null;\nconst bridgeId = (nmgModule && nmgModule.id)\n  || (Array.isArray(home.rooms) && home.rooms[0] && home.rooms[0].therm_relay)\n  || homeId;\nconst roomIds = Array.isArray(home.rooms) ? home.rooms.map(r => r.id) : [];\nif (!roomIds.length) { node.error('Aucune room dans homesdata.', msg); return null; }\nmsg.payload = {\n  date_begin: msg.date_begin,\n  date_end:   msg.date_end,\n  scale: '1day',\n  app_identifier: 'app_muller',\n  home: { id: homeId, rooms: roomIds.map(id => ({ id, bridge: bridgeId, type: 'sum_energy_elec$0' })) }\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1190,
        "y": 90,
        "wires": [
            [
                "f4d07f1088ee6ff9"
            ]
        ]
    },
    {
        "id": "f4d07f1088ee6ff9",
        "type": "http request",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "POST /api/gethomemeasure (1day)",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/gethomemeasure",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1500,
        "y": 90,
        "wires": [
            [
                "89ea31c75aac3ae0",
                "02f6d7f621a64af3"
            ]
        ]
    },
    {
        "id": "89ea31c75aac3ae0",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "CSV unique (daily) + base fin J-5",
        "func": "// Sortie : UN fichier CSV pour tous les sensors\n// Format: statistic_id,start,state,sum   avec start = \"dd.mm.yyyy 00:00\" (Europe/Zurich)\n\nconst body = msg.payload?.body; const rooms = body?.home?.rooms || [];\nif (!rooms.length) { return null; }\n\nconst exportDir = '/data/intuis/ha_import';\n\n// mapping room -> sensor_id (HA)\nconst MAP = {\n  '3165697331':'sensor.conso_entree_hourly',\n  '3330257038':'sensor.conso_chambre_d_amis_hourly',\n  '2979072780':'sensor.conso_salle_de_bain_filles_hourly',\n  '3957213003':'sensor.conso_chambre_filles_hourly',\n  '1707740468':'sensor.conso_chambre_parents_hourly',\n  '3807033309':'sensor.conso_couloir_hourly',\n  '1668330398':'sensor.conso_cuisine_hourly',\n  '3761003540':'sensor.conso_salle_a_manger_hourly',\n  '3357075329':'sensor.conso_salle_de_bain_parents_hourly',\n  '2064991252':'sensor.conso_salon_hourly',\n  '3864339241':'sensor.conso_toilettes_visiteurs_hourly'\n};\n\nfunction fmtStartDay(tsMs){\n  const d = new Date(tsMs);\n  const parts = new Intl.DateTimeFormat('fr-CH', { timeZone:'Europe/Zurich', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(d);\n  const get = t => parts.find(p => p.type === t)?.value || '';\n  return `${get('day')}.${get('month')}.${get('year')} 00:00`;\n}\n\nconst rows = [];       // {ts, sensorId, state, sum, startStr}\nconst baseMap = {};    // kWh cumulés fin J-5\n\nfor (const r of rooms){\n  const sensorId = MAP[r.id]; if (!sensorId) continue;\n  const m = r.measures && r.measures[0]; if (!m || !Array.isArray(m.value) || !m.value.length) continue;\n  const step = m.step_time || 86400; const edge0 = m.beg_time - step/2; // 00:00 local\n  let cumWh = 0;\n  for (let i=0;i<m.value.length;i++){\n    const tsEdge = (edge0 + i*step) * 1000;\n    const wh = Number(m.value[i][0]) || 0; cumWh += wh;\n    const state = (cumWh/1000); const sum = (cumWh/1000);\n    rows.push({ ts: tsEdge, sensorId, state, sum, startStr: fmtStartDay(tsEdge) });\n  }\n  baseMap[sensorId] = Number((cumWh/1000).toFixed(3));\n}\n\nrows.sort((a,b)=> a.ts - b.ts || (a.sensorId < b.sensorId ? -1 : 1));\n\nconst lines = ['statistic_id,start,state,sum'];\nfor (const r of rows){ lines.push(`${r.sensorId},${r.startStr},${r.state.toFixed(3)},${r.sum.toFixed(3)}`); }\n\nconst d0 = new Date(msg.date_begin*1000).toISOString().slice(0,10).replace(/-/g,'');\nconst d1 = new Date(msg.date_end*1000).toISOString().slice(0,10).replace(/-/g,'');\n\n// expose la base fin J-5\nglobal.set('ha_stat_base_90_end', baseMap);\n\nreturn [{ payload: lines.join('\\n')+'\\n', filename: `${exportDir}/ha_import_daily.csv` }];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1530,
        "y": 150,
        "wires": [
            [
                "7798508a88419ba7"
            ]
        ]
    },
    {
        "id": "7798508a88419ba7",
        "type": "file",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "Écrire CSV unique (overwrite)",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "utf8",
        "x": 1560,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "02f6d7f621a64af3",
        "type": "debug",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "DBG DAILY (optionnel)",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 1190,
        "y": 150,
        "wires": []
    },
    {
        "id": "25869d436d13e5b0",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "664426c7483c1246",
        "name": "Set Authorization header",
        "func": "// Récupère le token Intuis depuis global et prépare msg.token (Bearer ...)\nconst t = global.get('AccessToken') || global.get('token');\nif (!t) {\n  node.error('Token Intuis introuvable dans global.intuis_token / global.token');\n  return null;\n}\nmsg.token = t.startsWith('Bearer ') ? t : `Bearer ${t}`;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 160,
        "wires": [
            [
                "e42b9ca63874ea93"
            ]
        ]
    },
    {
        "id": "f5f0d60ec8534881",
        "type": "inject",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Tester maintenant (J-4 → J-1)",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 220,
        "y": 380,
        "wires": [
            [
                "d741fa5a11b6cc58"
            ]
        ]
    },
    {
        "id": "d741fa5a11b6cc58",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Fenêtre locale J-9 00:00 → J-1 23:59:59",
        "func": "const today = new Date();\ntoday.setHours(0,0,0,0); // 00:00 local aujourd'hui\nconst beginLocal = new Date(today.getTime() - 10*24*3600*1000); // J-4 00:00\nconst endLocal   = new Date(today.getTime());        // hier 23:59:59\nmsg.date_begin = Math.floor(beginLocal.getTime()/1000);\nmsg.date_end   = Math.floor(endLocal.getTime()/1000);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 410,
        "wires": [
            [
                "c9ed7a35aeacd5ee"
            ]
        ]
    },
    {
        "id": "6c9b85290160a68a",
        "type": "http request",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "GET /api/homesdata",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/homesdata",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Authorization",
                "valueType": "msg",
                "valueValue": "token"
            }
        ],
        "x": 940,
        "y": 410,
        "wires": [
            [
                "c004314fe09dbb61",
                "9fb7d89f8e79dc26"
            ]
        ]
    },
    {
        "id": "c004314fe09dbb61",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Build gethomemeasure (1h) depuis homesdata",
        "func": "const hd = msg.payload;\nconst home = hd && hd.body && Array.isArray(hd.body.homes) ? hd.body.homes[0] : null;\nif (!home) { node.error('homesdata inattendu: body.homes[0] manquant.', msg); return null; }\nconst homeId = home.id;\nconst nmgModule = Array.isArray(home.modules) ? home.modules.find(m => m.type === 'NMG') : null;\nconst bridgeId = (nmgModule && nmgModule.id)\n  || (Array.isArray(home.rooms) && home.rooms[0] && home.rooms[0].therm_relay)\n  || homeId;\nconst roomIds = Array.isArray(home.rooms) ? home.rooms.map(r => r.id) : [];\nif (!roomIds.length) { node.error('Aucune room dans homesdata.', msg); return null; }\nmsg.payload = {\n  date_begin: msg.date_begin,\n  date_end:   msg.date_end,\n  scale: '1hour',\n  app_identifier: 'app_muller',\n  home: { id: homeId, rooms: roomIds.map(id => ({ id, bridge: bridgeId, type: 'sum_energy_elec$0' })) }\n};\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 440,
        "wires": [
            [
                "e871efe62d94e232"
            ]
        ]
    },
    {
        "id": "e871efe62d94e232",
        "type": "http request",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "POST /api/gethomemeasure (1hour)",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/gethomemeasure",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1670,
        "y": 440,
        "wires": [
            [
                "09afbedac84a3b08"
            ]
        ]
    },
    {
        "id": "09afbedac84a3b08",
        "type": "change",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Garder mesure → msg.measure",
        "rules": [
            {
                "t": "set",
                "p": "measure",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "x": 270,
        "y": 520,
        "wires": [
            [
                "7b446a7479a157d9"
            ]
        ]
    },
    {
        "id": "7b446a7479a157d9",
        "type": "file in",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Lire /data/intuis/ha_import/daily/ha_import_daily.csv",
        "filename": "/data/intuis/ha_import/ha_import_daily.csv",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": true,
        "encoding": "none",
        "allProps": false,
        "x": 660,
        "y": 520,
        "wires": [
            [
                "286119c2c9222470"
            ]
        ]
    },
    {
        "id": "286119c2c9222470",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Make HOURLY import (1 fichier toutes pièces, cumul = daily fin + heures)",
        "func": "// Entrées:\n//  - msg.measure = réponse /gethomemeasure (1h) pour J-4 → J-1\n//  - msg.payload = contenu texte du ha_import_daily.csv (si dispo)\n// Sortie:\n//  - /data/intuis/ha_import/ha_import_hourly.csv\n\nconst MAP = {\n  '3165697331':'sensor.conso_entree_hourly',\n  '3330257038':'sensor.conso_chambre_d_amis_hourly',\n  '2979072780':'sensor.conso_salle_de_bain_filles_hourly',\n  '3957213003':'sensor.conso_chambre_filles_hourly',\n  '1707740468':'sensor.conso_chambre_parents_hourly',\n  '3807033309':'sensor.conso_couloir_hourly',\n  '1668330398':'sensor.conso_cuisine_hourly',\n  '3761003540':'sensor.conso_salle_a_manger_hourly',\n  '3357075329':'sensor.conso_salle_de_bain_parents_hourly',\n  '2064991252':'sensor.conso_salon_hourly',\n  '3864339241':'sensor.conso_toilettes_visiteurs_hourly'\n};\n\nfunction fmtLocal(tsMs){\n  const parts = new Intl.DateTimeFormat('fr-CH',{\n    timeZone:'Europe/Zurich',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false\n  }).formatToParts(new Date(tsMs));\n  const get=t=>parts.find(p=>p.type===t)?.value||'';\n  return `${get('day')}.${get('month')}.${get('year')} ${get('hour')}:${get('minute')}`;\n}\n\n// 1) baseSums depuis le DAILY (max sum par sensor)\nconst baseSums = {}; // kWh\ntry {\n  const text = typeof msg.payload === 'string' ? msg.payload : '';\n  if (text) {\n    const lines = text.trim().split(/\\r?\\n/);\n    for (const line of lines.slice(1)) {\n      const parts = line.split(',');\n      if (parts.length < 4) continue;\n      const sensor = parts[0];\n      const sum = Number(parts[3]);\n      if (!Number.isFinite(sum)) continue;\n      baseSums[sensor] = Math.max(baseSums[sensor] || 0, sum);\n    }\n  }\n} catch(e){ node.warn('Lecture daily.csv impossible: '+e.message); }\n\n// 2) mesures horaires\nconst body = msg.measure?.body; const rooms = body?.home?.rooms || [];\nif (!rooms.length) return null;\n\nconst lines = ['statistic_id,start,state,sum'];\nfor (const r of rooms){\n  const sensorId = MAP[r.id]; if (!sensorId) continue;\n  const m = r?.measures?.[0]; if (!m || !Array.isArray(m.value) || !m.value.length) continue;\n  const step = m.step_time || 3600;          // 1h\n  const edge0 = m.beg_time - step/2;         // H:00 local\n\n  // cumul continu: on part du dernier cumul du daily\n  let totalWh = (baseSums[sensorId] || 0) * 1000; // kWh -> Wh\n\n  for (let i=0;i<m.value.length;i++){\n    const tsEdgeMs = (edge0 + i*step) * 1000;\n    const wh = Number(m.value[i][0]) || 0; totalWh += wh;\n    const kwh = totalWh/1000;\n    const startStr = fmtLocal(tsEdgeMs);\n    lines.push(`${sensorId},${startStr},${kwh.toFixed(3)},${kwh.toFixed(3)}`);\n  }\n}\n\nmsg.payload = lines.join('\\n')+'\\n';\nmsg.filename = '/data/intuis/ha_import/ha_import_hourly.csv';\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 520,
        "wires": [
            [
                "09048c6352824c6f"
            ]
        ]
    },
    {
        "id": "09048c6352824c6f",
        "type": "file",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Écrire ha_import_hourly.csv (overwrite)",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "utf8",
        "x": 1610,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "9fb7d89f8e79dc26",
        "type": "debug",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "DBG API (optionnel)",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "measure",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1220,
        "y": 340,
        "wires": []
    },
    {
        "id": "c9ed7a35aeacd5ee",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "8966036e727ee1b2",
        "name": "Set Authorization header",
        "func": "// Récupère le token Intuis depuis global et prépare msg.token (Bearer ...)\nconst t = global.get('AccessToken') || global.get('token');\nif (!t) {\n  node.error('Token Intuis introuvable dans global.intuis_token / global.token');\n  return null;\n}\nmsg.token = t.startsWith('Bearer ') ? t : `Bearer ${t}`;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 340,
        "wires": [
            [
                "6c9b85290160a68a"
            ]
        ]
    },
    {
        "id": "4d408e1ee1df8619",
        "type": "inject",
        "z": "8322e2d81f057f60",
        "g": "71dbb83f1cd1e302",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 190,
        "y": 740,
        "wires": [
            [
                "601b073a9f5699f4"
            ]
        ]
    },
    {
        "id": "601b073a9f5699f4",
        "type": "file in",
        "z": "8322e2d81f057f60",
        "g": "71dbb83f1cd1e302",
        "name": "ha_import_hourly.csv",
        "filename": "/data/intuis/ha_import/ha_import_hourly.csv",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "utf8",
        "allProps": false,
        "x": 440,
        "y": 740,
        "wires": [
            [
                "7e016e08c43d0df3"
            ]
        ]
    },
    {
        "id": "7e016e08c43d0df3",
        "type": "function",
        "z": "8322e2d81f057f60",
        "g": "71dbb83f1cd1e302",
        "name": "Pousse Base_kWh prends j-1 à 23h00",
        "func": "// Lit msg.payload (CSV texte) et charge base_kwh = somme à \"hier 00:00\" (Europe/Zurich)\n// CSV format: statistic_id,start,state,sum   avec start \"dd.mm.yyyy HH:MM\"\n\nconst text = (typeof msg.payload === 'string') ? msg.payload : '';\nif (!text) { node.warn('CSV vide'); return null; }\n\nconst lines = text.trim().split(/\\r?\\n/);\nif (lines.length <= 1) { node.warn('CSV: seulement l’en-tête ?'); return null; }\n\nconst header = lines[0].toLowerCase();\nif (!(header.includes('statistic_id') && header.includes('start') && header.includes('sum'))) {\n  node.error('Entête inattendu (attendu: statistic_id,start,state,sum)'); \n  return null;\n}\n\n// construit la chaîne \"hier 00:00\" au format du CSV (Europe/Zurich)\nconst tz = 'Europe/Zurich';\nconst now = new Date();\nconst todayLocal = new Intl.DateTimeFormat('fr-CH', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' })\n                     .formatToParts(now);\nfunction toLocalMidnightYesterdayString(){\n  // calcule \"hier\" local\n  const d = new Date(now);\n  // passe à 00:00 local d'aujourd'hui puis -1 jour\n  const today00 = new Date(d);\n  // remet en 00:00 local par décalage de l'objet Date \"naif\"\n  today00.setHours(0,0,0,0);\n  const y = new Date(today00.getTime() - 24*3600*1000 );\n  const parts = new Intl.DateTimeFormat('fr-CH', {\n    timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit',\n    hour:'2-digit', minute:'2-digit', hour12:false\n  }).formatToParts(y);\n  const get = t => parts.find(p => p.type===t)?.value || '';\n  // IMPORTANT: on force \"00:00\"\n  const dd = get('day'), mm = get('month'), yyyy = get('year');\n  return `${dd}.${mm}.${yyyy} 23:00`;\n}\nconst targetStart = toLocalMidnightYesterdayString();\n\nconst base = {};\nfor (let i=1;i<lines.length;i++){\n  const line = lines[i].trim(); if (!line) continue;\n  const [id,start, stateS, sumS] = line.split(',');\n  if (!id || !start || sumS===undefined) continue;\n  if (start.trim() !== targetStart) continue;\n  let sum = Number(sumS);\n  if (!Number.isFinite(sum)) {\n    const st = Number(stateS);\n    if (Number.isFinite(st)) sum = st;\n  }\n  if (!Number.isFinite(sum)) continue;\n  base[id.trim()] = Number(sum.toFixed(3));\n}\n\n// Sauvegarde globale (store file si dispo)\nconst STORE = 'file';\ntry { global.set('base_kwh', base, STORE); } catch(e) { global.set('base_kwh', base); }\n\nnode.status({fill:'green',shape:'dot',text:`baseline (avant-hier soir) chargée: ${Object.keys(base).length} sensors`});\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "a4cc152feb07a94d",
        "type": "http request",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Intuis gethomemeasure",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://app.muller-intuitiv.net/api/gethomemeasure",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "Authorization",
                "keyValue": "",
                "valueType": "msg",
                "valueValue": "token"
            },
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1090,
        "y": 220,
        "wires": [
            [
                "b6b5460f08d34b31",
                "2710c1f1040d343c",
                "fa6103c020074676",
                "b2878673f4d5558f",
                "437c3dcac27ed8ca",
                "22440edd3cd5e1e8",
                "1dcdb6e47dd52c38",
                "7ced2ac927d6ddfd",
                "9b2b8ba1453c18c6",
                "355d9660ad39ed64",
                "3da322fc6ede92bd",
                "e8645fa04460607f",
                "0587fb740ba0c6e2"
            ]
        ]
    },
    {
        "id": "b6b5460f08d34b31",
        "type": "debug",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Intuis gethomemeasure",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1410,
        "y": 120,
        "wires": []
    },
    {
        "id": "2710c1f1040d343c",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 0 Entrée",
        "entityConfig": "7cc9b3f8711a30db",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room0_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1430,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "fa6103c020074676",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Calcul conso totale",
        "func": "try {\n    const rooms = msg.payload?.body?.home?.rooms;\n    if (!Array.isArray(rooms)) {\n        throw new Error(\"Liste de pièces non trouvée dans le payload.\");\n    }\n\n    const roomIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; \n\n    let consoTotal = 0;\n\n    for (let i of roomIndexes) {\n        const value = rooms[i]?.measures?.[0]?.value?.[0]?.[0];\n        if (typeof value !== 'number') {\n            node.warn(`Valeur manquante ou invalide pour la pièce ${i}`);\n            continue;\n        }\n        consoTotal += value;\n    }\n\n    msg.consototal = consoTotal;\n} catch (err) {\n    node.error(\"Erreur lors du calcul de la consommation : \" + err.message, msg);\n    msg.consototal = null;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1390,
        "y": 180,
        "wires": [
            [
                "123754ca51635627"
            ]
        ]
    },
    {
        "id": "123754ca51635627",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation totale chauffage",
        "entityConfig": "6dbc88116a89ee2d",
        "version": 0,
        "state": "consototal",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1690,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "b2878673f4d5558f",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 1 Chambre D'amis",
        "entityConfig": "76054f9f12d4abf5",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room1_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1450,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "505894bb1a05220a",
        "type": "comment",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Pensez à créer les entitées à rattacher aux différents capteurs",
        "info": "",
        "x": 1520,
        "y": 360,
        "wires": []
    },
    {
        "id": "338911d72efbbe8c",
        "type": "comment",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "A compléter selon nombre de pièces ",
        "info": "",
        "x": 740,
        "y": 340,
        "wires": []
    },
    {
        "id": "08b2ea1c720daa15",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "veille 12h01",
        "func": "var a = new Date();\na.setHours(12, 1, 0, 0); \na.setDate(a.getDate() - 1); \nvar b = a.getTime(); \nvar c = b / 1000; \n\n{\n    node.status({ fill: \"blue\", shape: \"ring\", text: c });\n    msg.debut = c;\n    return msg;\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 400,
        "wires": [
            [
                "185ddd9b17bb0a37"
            ]
        ]
    },
    {
        "id": "a266a93279736ddc",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "jour J 23h59",
        "func": "var d = new Date();\nvar e = d.setHours(23,59,59,0);\nvar f = e / 1000\n\n{\n    node.status({fill:\"blue\",shape:\"ring\", text:f});\n    msg.fin = f;\n    return msg;\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 460,
        "wires": [
            [
                "d841c63b71740859"
            ]
        ]
    },
    {
        "id": "185ddd9b17bb0a37",
        "type": "change",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "debut",
                "pt": "global",
                "to": "debut",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 370,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "d841c63b71740859",
        "type": "change",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "fin",
                "pt": "global",
                "to": "fin",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "23fac8d45049a21a",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "veille 00h00",
        "func": "var g = new Date();\ng.setDate(g.getDate() - 1);\nvar h = g.setHours(0,0,0,0);\nvar i = h / 1000;\n\n{\n    node.status({ fill: \"blue\", shape: \"ring\", text:i});  \n    msg.veille_debut = i;\n    return msg;\n}\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 520,
        "wires": [
            [
                "6ca8f00ce04e6a05"
            ]
        ]
    },
    {
        "id": "5d7b35ae2e6d9034",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "veille 23h59",
        "func": "var j = new Date();\nj.setDate(j.getDate() - 1);\nvar k = j.setHours(23,59,59,0);\nvar l = k / 1000\n\n{\n    node.status({fill:\"blue\",shape:\"ring\", text:l});\n    msg.veille_fin = l;\n    return msg;\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 580,
        "wires": [
            [
                "1e5842fa93ba08f9"
            ]
        ]
    },
    {
        "id": "6ca8f00ce04e6a05",
        "type": "change",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "veille_debut",
                "pt": "global",
                "to": "veille_debut",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 390,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "1e5842fa93ba08f9",
        "type": "change",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "b4a36816213b7b3b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "veille_fin",
                "pt": "global",
                "to": "veille_fin",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 380,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "5167574474aa85ad",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "00h00 - 01h00",
        "func": "var now = new Date ();\nvar hours = now.getHours();\nvar minutes = now.getMinutes();\n\nif ((hours >= 0 && hours < 1) || (hours === 1 && minutes === 0)) {\n    node.status({fill:\"blue\",shape:\"ring\", text:\"après 00h et avant 01h\"});\n    return [msg, null]; // Sortie 1 \n} else { \n    node.status({fill:\"blue\",shape:\"ring\", text:\"après 01h et avant 00h\"});\n    return [null, msg]; // Sortie 2 \n}\n        ",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 220,
        "wires": [
            [
                "f4dd2e98edd78e6e",
                "a12369b4d0ccaa7b"
            ],
            [
                "c862b6e600f79faf",
                "f31753e734587037"
            ]
        ]
    },
    {
        "id": "a262f752091ad391",
        "type": "debug",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "contrôle requête veille",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 140,
        "wires": []
    },
    {
        "id": "1367850bf3537e88",
        "type": "debug",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "contrôle requête jour J",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 300,
        "wires": []
    },
    {
        "id": "4e44207618b4aa90",
        "type": "comment",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "A compléter selon nombre de pièces ",
        "info": "",
        "x": 740,
        "y": 100,
        "wires": []
    },
    {
        "id": "9b2b8ba1453c18c6",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 6 Salon",
        "entityConfig": "cefcb67d6f9bc3da",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room6_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1420,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "1dcdb6e47dd52c38",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 4 Couloir",
        "entityConfig": "8f644be40527e388",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room4_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1430,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "7ced2ac927d6ddfd",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 5 Toilettes Visiteurs",
        "entityConfig": "4b11554c2980b712",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room5_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1450,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "22440edd3cd5e1e8",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 3 Chambre Filles",
        "entityConfig": "5ae30bb9c36e011d",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room3_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1440,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "437c3dcac27ed8ca",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 2 Salle De Bain Filles",
        "entityConfig": "a8598d514ddc2992",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room1_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1450,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "355d9660ad39ed64",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 7 Salle à manger Cuisine",
        "entityConfig": "26429a74f02e051a",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room7_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1460,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "e8645fa04460607f",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 10 Chambre Parents",
        "entityConfig": "69f87646ef646ef7",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room10_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1770,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "3da322fc6ede92bd",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 9 Cuisine",
        "entityConfig": "303c882f16d16f3f",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room9_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1750,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "f4dd2e98edd78e6e",
        "type": "change",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Set param get config 2 (veille)",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t  \"date_end\": $globalContext(\"veille_fin\"),\t  \"home\": {\t    \"id\": $globalContext(\"home_id\"),\t    \"rooms\": [\t      {\t        \"id\": $globalContext(\"room0_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room1_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room2_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room3_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room4_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room5_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room6_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room7_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room8_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room9_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room10_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      }\t    ]\t  },\t  \"app_identifier\": \"app_muller\",\t  \"date_begin\": $globalContext(\"veille_debut\"),\t  \"scale\": \"1hour\"\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 730,
        "y": 140,
        "wires": [
            [
                "a262f752091ad391",
                "a4cc152feb07a94d"
            ]
        ]
    },
    {
        "id": "0587fb740ba0c6e2",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Consommation Room 8 Salle de bains Parents",
        "entityConfig": "9f31c4d71a2d6603",
        "version": 0,
        "state": "$filter(payload.body.home.rooms, function($v){ $v.id = $globalContext('room8_id') })[0].measures[0].value[0][0]",
        "stateType": "jsonata",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1780,
        "y": 360,
        "wires": [
            []
        ]
    },
    {
        "id": "c862b6e600f79faf",
        "type": "change",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "Set param get config 2 (jour J)",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t  \"date_end\": $globalContext(\"fin\"),\t  \"home\": {\t    \"id\": $globalContext(\"home_id\"),\t    \"rooms\": [\t      {\t        \"id\": $globalContext(\"room0_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room1_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room2_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room3_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room4_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room5_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room6_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room7_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room8_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room9_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      },\t      {\t        \"id\": $globalContext(\"room10_id\"),\t        \"bridge\": $globalContext(\"routeur_id\"),\t        \"type\": \"sum_energy_elec$0\"\t      }\t    ]\t  },\t  \"app_identifier\": \"app_muller\",\t  \"date_begin\": $globalContext(\"debut\"),\t  \"scale\": \"1hour\"\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 730,
        "y": 300,
        "wires": [
            [
                "1367850bf3537e88"
            ]
        ]
    },
    {
        "id": "f31753e734587037",
        "type": "debug",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "03h-00h",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 260,
        "wires": []
    },
    {
        "id": "a12369b4d0ccaa7b",
        "type": "debug",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "84c133862c6ab1a2",
        "name": "00h-03h",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 180,
        "wires": []
    },
    {
        "id": "b61e71b6d6f19ece",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "d": true,
        "g": "3635aba12bfcd685",
        "name": "Determination slot",
        "func": "// Slot courant = dernier point dispo (heure la plus récente du jour demandé)\nconst rooms = msg.payload?.body?.home?.rooms || [];\nlet slot = -1;\nlet step = 3600;\nlet edge0 = null;\n\nfor (const r of rooms) {\n  const m = r?.measures?.[0];\n  if (!m || !Array.isArray(m.value) || !m.value.length) continue;\n  step = m.step_time || step;\n  edge0 = edge0 == null ? (m.beg_time - (m.step_time || 3600)/2) : Math.min(edge0, m.beg_time - (m.step_time || 3600)/2);\n  slot = Math.max(slot, m.value.length - 1);\n}\n\nif (slot < 0) {\n  node.warn(\"Aucun point horaire renvoyé.\");\n  return null;\n}\n\n// Infos utiles (debug/attributs éventuels)\nmsg.slot = slot;                         // index dans measures[0].value\nmsg.slot_time = edge0 != null ? (edge0 + slot*step) : null;  // début d'heure (epoch sec)\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 760,
        "wires": [
            [
                "a35e9026e8735096",
                "684785b2a78095a2",
                "3f86109f5d6beb72",
                "e009ac72275552a5",
                "08c328f6c4fe5889",
                "08b89e016f746c15",
                "b299b86b04518d56",
                "4ee703fbb4bdf889",
                "aaa489d26e569f9f",
                "f36776ed9d43e90a",
                "9029c59bd55b8b9e",
                "42fc4bac6bb615b5"
            ]
        ]
    },
    {
        "id": "e887f9be2d84e086",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 0 Entrée",
        "entityConfig": "7b221a85b3bf93a9",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 990,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "a35e9026e8735096",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Calcul conso totale",
        "func": "try {\n  const rooms = msg.payload?.body?.home?.rooms;\n  const slot = Number(msg.slot) || 0;\n  if (!Array.isArray(rooms)) throw new Error(\"Liste de pièces absente\");\n  let consoTotal = 0;\n\n  for (const r of rooms) {\n    const v = r?.measures?.[0]?.value?.[slot]?.[0];\n    if (typeof v === 'number' && isFinite(v)) consoTotal += v;\n  }\n  msg.consototal = consoTotal; // Wh sur l’heure sélectionnée\n} catch (err) {\n  node.error(\"Erreur calcul conso totale: \" + err.message, msg);\n  msg.consototal = null;\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "7d914e261e87ed1e",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 1 Chambre d'amis",
        "entityConfig": "ec1a2b3c4d5e6f702",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1020,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "09643c498e845545",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 2 Salle de bain filles",
        "entityConfig": "ec1a2b3c4d5e6f703",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1030,
        "y": 900,
        "wires": [
            []
        ]
    },
    {
        "id": "ea173eab5a7b1f3f",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 3 Chambre filles",
        "entityConfig": "ec1a2b3c4d5e6f704",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1030,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "5ff0759a08227d28",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 4 Couloir",
        "entityConfig": "ec1a2b3c4d5e6f705",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1030,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "20ab1ab4c379bbdc",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 5 Toilettes visiteurs",
        "entityConfig": "ec1a2b3c4d5e6f706",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1040,
        "y": 1080,
        "wires": [
            []
        ]
    },
    {
        "id": "d758a9a23a1fc8f5",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 6 Salon",
        "entityConfig": "ec1a2b3c4d5e6f707",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1050,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "ee1936464dcdb204",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 7 Salle à manger",
        "entityConfig": "ec1a2b3c4d5e6f708",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1060,
        "y": 1200,
        "wires": [
            []
        ]
    },
    {
        "id": "839e113280f8d64e",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 8 Salle de bain parents",
        "entityConfig": "ec1a2b3c4d5e6f709",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1050,
        "y": 1260,
        "wires": [
            []
        ]
    },
    {
        "id": "11ef43c80b115863",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 9 Cuisine",
        "entityConfig": "ec1a2b3c4d5e6f70a",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1010,
        "y": 1320,
        "wires": [
            []
        ]
    },
    {
        "id": "a4ae6594c911a7e0",
        "type": "ha-sensor",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Consommation Room 10 Chambre parents",
        "entityConfig": "ec1a2b3c4d5e6f70b",
        "version": 0,
        "state": "payload",
        "stateType": "msg",
        "attributes": [],
        "inputOverride": "allow",
        "outputProperties": [],
        "x": 1050,
        "y": 1380,
        "wires": [
            []
        ]
    },
    {
        "id": "3f86109f5d6beb72",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Entrée → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room0_id'); const SENSOR_ID=\"sensor.conso_entree_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 760,
        "wires": [
            [
                "e887f9be2d84e086"
            ]
        ]
    },
    {
        "id": "684785b2a78095a2",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Chambre d'amis → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room1_id'); const SENSOR_ID=\"sensor.conso_chambre_d_amis_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 840,
        "wires": [
            [
                "7d914e261e87ed1e"
            ]
        ]
    },
    {
        "id": "e009ac72275552a5",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso SDB filles → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room2_id'); const SENSOR_ID=\"sensor.conso_salle_de_bain_filles_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 900,
        "wires": [
            [
                "09643c498e845545"
            ]
        ]
    },
    {
        "id": "08c328f6c4fe5889",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Chambre filles → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room3_id'); const SENSOR_ID=\"sensor.conso_chambre_filles_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 960,
        "wires": [
            [
                "ea173eab5a7b1f3f"
            ]
        ]
    },
    {
        "id": "08b89e016f746c15",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Couloir → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room4_id'); const SENSOR_ID=\"sensor.conso_couloir_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1020,
        "wires": [
            [
                "5ff0759a08227d28"
            ]
        ]
    },
    {
        "id": "b299b86b04518d56",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Toilettes visiteurs → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room5_id'); const SENSOR_ID=\"sensor.conso_toilettes_visiteurs_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1080,
        "wires": [
            [
                "20ab1ab4c379bbdc"
            ]
        ]
    },
    {
        "id": "4ee703fbb4bdf889",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Salon → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room6_id'); const SENSOR_ID=\"sensor.conso_salon_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1140,
        "wires": [
            [
                "d758a9a23a1fc8f5"
            ]
        ]
    },
    {
        "id": "aaa489d26e569f9f",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Salle à manger → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room7_id'); const SENSOR_ID=\"sensor.conso_salle_a_manger_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1200,
        "wires": [
            [
                "ee1936464dcdb204"
            ]
        ]
    },
    {
        "id": "f36776ed9d43e90a",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso SDB parents → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room8_id'); const SENSOR_ID=\"sensor.conso_salle_de_bain_parents_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1260,
        "wires": [
            [
                "839e113280f8d64e"
            ]
        ]
    },
    {
        "id": "9029c59bd55b8b9e",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Cuisine → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room9_id'); const SENSOR_ID=\"sensor.conso_cuisine_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1320,
        "wires": [
            [
                "11ef43c80b115863"
            ]
        ]
    },
    {
        "id": "42fc4bac6bb615b5",
        "type": "function",
        "z": "c8fb396ecc5efcfc",
        "g": "3635aba12bfcd685",
        "name": "Conso Chambre parents → kWh (jour + retard)",
        "func": "const ROOM_ID=$globalContext('room10_id'); const SENSOR_ID=\"sensor.conso_chambre_parents_hourly\";\nconst lagH=Number(global.get('intuis_lag_hours'))||5; const nowSec=Math.floor(Date.now()/1000); const deadlineSec=nowSec-lagH*3600;\nconst rooms=msg.payload?.body?.home?.rooms||[]; const r=rooms.find(x=>x.id===ROOM_ID); const m=r?.measures?.[0]; if(!m||!Array.isArray(m.value)) return null;\nconst step=m.step_time||3600; const edge0=(m.beg_time||0)-step/2; let todayWh=0; for(let i=0;i<m.value.length;i++){ const tsEdge=edge0+i*step; if(tsEdge>deadlineSec) break; const v=Array.isArray(m.value[i])?Number(m.value[i][0]):NaN; if(Number.isFinite(v)) todayWh+=v; }\nconst base=Number((global.get('base_kwh')||{})[SENSOR_ID])||0; const todayKwh=todayWh/1000; const STORE='file'; function cget(k){try{return context.get(k,STORE);}catch(e){return context.get(k);}} function cset(k,v){try{context.set(k,v,STORE);}catch(e){context.set(k,v);}}\nconst lastKey=`energy_last_${ROOM_ID}`; const proposed=Number((base+todayKwh).toFixed(3)); const prev=Number(cget(lastKey))||0; const total=Math.max(prev,proposed); cset(lastKey,total); msg.payload=total; return msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1380,
        "wires": [
            [
                "a4ae6594c911a7e0"
            ]
        ]
    }
]
