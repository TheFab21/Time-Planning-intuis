<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Therm Planning – Semaine complète</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 16px; background: #fafafa; color: #212121; }
    h2 { margin: 0 0 12px; }
    select, button, input { font: inherit; }
    #week { margin-top: 16px; border-top: 1px solid #ccc; }
    .row { display: flex; align-items: center; margin: 2px 0; font-size: 12px; }
    .lbl { width: 42px; text-align: right; padding-right: 4px; }
    .bar { flex: 1; position: relative; height: 22px; border: 1px solid #ccc; display: flex; background: #fafbfc; border-radius: 7px; margin: 0 8px; overflow: hidden;}
    .seg { cursor: pointer; height: 100%; border-radius: 0; transition: filter .17s;}
    .seg:hover { filter: brightness(1.16) contrast(1.08); outline: 2px solid #666; z-index: 1; }
    .tick { position: absolute; top: -12px; font-size: 9px; transform: translateX(-50%); color: #888; }
    .legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px; margin: 10px 0; }
    .legend span { display: flex; align-items: center; gap: 4px; }
    .legend i { width: 14px; height: 14px; border: 1px solid #888; border-radius: 3px; display: inline-block; }
    #zones { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; }
    .zonebox { border-radius: 7px; border: 1px solid #ccc; padding: 8px; min-width: 180px; background: var(--zone-bg,#fff); box-shadow: 0 1px 3px #0001;}
    .zonebox h4 { margin: 0 0 6px 0; font-size: 15px; display: flex; align-items: center; gap: 6px;}
    .zonecolor { width: 18px; height: 18px; border-radius: 4px; display: inline-block; vertical-align: middle;}
    .temp { display: flex; align-items: center; gap: 7px; margin: 4px 0; font-size: 13px; }
    .temp span:first-child { width: 92px; overflow: hidden; text-overflow: ellipsis; }
    .temp input[type="number"] { width: 44px; padding: 2px 3px; }
    .plusbtn { background: #eee; border: 1px solid #aaa; border-radius: 50%; font-size: 16px; width: 22px; height: 22px; cursor: pointer; margin-left: 10px;}
    .top-controls { display: flex; align-items: center; gap: 18px;}
    .t-edit { display: flex; gap: 10px; align-items: center; margin-bottom: 10px;}
    .t-edit label {font-size:13px;}
    .t-edit input[type="number"] { width:38px; }
    dialog { border: none; border-radius: 8px; padding: 18px; box-shadow: 0 4px 12px rgba(0,0,0,.25); width: 300px; }
    dialog::backdrop { background: rgba(0,0,0,.45); }
    dialog label { display: block; margin: 8px 0; font-size: 14px; }
    dialog menu { display: flex; justify-content: flex-end; gap: 8px; margin-top: 14px; }
  </style>
</head>
<body>
  <h2>Therm Planning – Semaine complète</h2>
  <div class="top-controls">
    <label>Planning : <select id="planner"></select></label>
    <span class="t-edit">
      <label>Absent <input id="away" type="number" min="4" max="24" step="0.5"></label>
      <label>Hors-gel <input id="hg" type="number" min="-5" max="15" step="0.5"></label>
    </span>
  </div>
  <div id="week"></div>
  <div id="legend" class="legend"></div>
  <h3>Températures par zone</h3>
  <div id="zones"></div>
  <button id="save" disabled>Enregistrer</button>
  <dialog id="dlg">
    <form method="dialog">
      <h3 id="dlgTitle">Éditer créneau</h3>
      <label>Début <input type="time" id="dStart" required></label>
      <label>Fin   <select id="dEndDay"></select> <input type="time" id="dEnd"   required></label>
      <label>Zone <select id="dZone"></select></label>
      <menu>
                    <!-- on met formnovalidate pour bypasser le required -->
            <button type="submit" value="cancel" formnovalidate>Annuler</button>
            <button type="submit" value="default">OK</button>
      </menu>
    </form>
  </dialog>
<script>
(async()=>{
  const COLORS = ['#4caf50','#2196f3','#ff9800','#9c27b0','#f44336','#3f51b5','#795548','#009688','#00bcd4','#e91e63'];
  const fmt = m => `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
  const DAY = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  const TICKS = [0,360,720,1080];

  function hex2rgba(hex, alpha=0.23) {
    hex = hex.replace('#','');
    if(hex.length===3) hex = hex.split('').map(x=>x+x).join('');
    const r=parseInt(hex.slice(0,2),16),
          g=parseInt(hex.slice(2,4),16),
          b=parseInt(hex.slice(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  const sel = document.getElementById('planner');
  const week = document.getElementById('week');
  const legend = document.getElementById('legend');
  const zonesDiv = document.getElementById('zones');
  const saveBtn = document.getElementById('save');
  const dlg = document.getElementById('dlg');
  const dlgTitle = document.getElementById('dlgTitle');
  const dStart = document.getElementById('dStart');
  const dEnd = document.getElementById('dEnd');
  const dEndDay = document.getElementById('dEndDay');
  const dZone = document.getElementById('dZone');
  const away = document.getElementById('away');
  const hg = document.getElementById('hg');

  let ROOM_MAP = null;
  function getRoomMap(hass) {
    if(ROOM_MAP) return ROOM_MAP;
    ROOM_MAP = {};
    hass.states['sensor.liste_pieces_lens']?.attributes?.raw_json?.forEach(r=> ROOM_MAP[r.id] = r.name);
    return ROOM_MAP;
  }
  function getHass(){
    if(window.parent && window.parent.document && window.parent.document.querySelector('home-assistant'))
      return window.parent.document.querySelector('home-assistant').hass;
    return window.hass || null;
  }
  let hass = null;
  for(let i=0;i<60;i++){
    hass = getHass();
    if(hass) break;
    await new Promise(res=>setTimeout(res,150));
  }
  if(!hass) { alert("Impossible de récupérer hass."); return; }

  const PLANNERS = Object.entries(hass.states)
    .filter(([id,e]) => id.startsWith('sensor.') && e.attributes?.timetable);
  PLANNERS.forEach(([id,e]) => {
    const o = document.createElement('option');
    o.value = id;
    o.textContent = e.attributes.name || id;
    sel.appendChild(o);
  });

  let current = null, dirty = false, editing = null;
  const markDirty = () => { dirty = true; saveBtn.disabled = false; };

  function normalize() {
    let tt = [...current.timetable].sort((a,b)=>a.m_offset-b.m_offset);
    let res = [];
    for (let d = 0; d < 7; d++) {
      let base = d * 1440, next = base + 1440;
      let slots = tt.filter(s => s.m_offset >= base && s.m_offset < next);
      let firstZone = (tt.filter(s=>s.m_offset<base).slice(-1)[0]?.zone_id) ?? (slots[0]?.zone_id ?? tt[0]?.zone_id ?? 0);
      if (!slots.length || slots[0].m_offset > base) slots.unshift({zone_id: firstZone, m_offset: base});
      if (slots[slots.length-1].m_offset < next) {
        let lastZone = slots[slots.length-1].zone_id;
        slots.push({zone_id: lastZone, m_offset: next});
      }
      for (let i=0; i<slots.length-1; i++) res.push({ zone_id: slots[i].zone_id, m_offset: slots[i].m_offset });
    }
    let merged = [];
    for (let i=0; i<res.length; i++) {
      if (merged.length && merged[merged.length-1].zone_id === res[i].zone_id) continue;
      merged.push(res[i]);
    }
    current.timetable = merged;
  }

  function getZoneIdAt(tt, offset) {
    const before = tt.filter(s => s.m_offset <= offset);
    if(before.length === 0) return tt.length > 0 ? tt[0].zone_id : 0;
    return before[before.length - 1].zone_id;
  }

  // === INSERTION ===
  // === INSERTION ===
function insertSlot(day, endDay, ns, ne, zid) {
  const start = day * 1440 + ns;
  let end = endDay * 1440 + ne;
  if (end <= start) end += 7 * 1440;

  let tt = [...current.timetable].sort((a, b) => a.m_offset - b.m_offset);

  const zoneAfter = getZoneIdAt(tt, end % (7 * 1440));

  if (end > start) {
    tt = tt.filter(s => !(s.m_offset > start && s.m_offset < end));
  } else {
    tt = tt.filter(s => !((s.m_offset > start && s.m_offset < 7*1440) || (s.m_offset > 0 && s.m_offset < end)));
  }

  tt.push({ zone_id: zid, m_offset: start % (7 * 1440) });
  tt.push({ zone_id: zoneAfter, m_offset: end % (7 * 1440) });

  tt.sort((a, b) => a.m_offset - b.m_offset);
  let merged = [];
  for (let i = 0; i < tt.length; i++) {
    if (merged.length && merged[merged.length - 1].zone_id === tt[i].zone_id) continue;
    merged.push(tt[i]);
  }
  current.timetable = merged;
  normalize();
  markDirty();
  render();
}


  // === ÉDITION ===
  function editSlot(day, orig_start, orig_end_day, orig_end, new_start, new_end_day, new_end, zid) {
    const span = 7 * 1440;
    const origStart = day * 1440 + orig_start;
    let origEnd = orig_end_day * 1440 + orig_end;
    if (origEnd <= origStart) origEnd += span;

    const newStartAbs = day * 1440 + new_start;
    let newEndAbs = new_end_day * 1440 + new_end;
    if (newEndAbs <= newStartAbs) newEndAbs += span;

    const startUnion = Math.min(origStart, newStartAbs);
    const endUnion = Math.max(origEnd, newEndAbs);

    const oldSlots = [...current.timetable].sort((a, b) => a.m_offset - b.m_offset);
    let expanded = oldSlots
      .concat(oldSlots.map(s => ({ ...s, m_offset: s.m_offset + span })))
      .sort((a,b)=>a.m_offset-b.m_offset);

    const zoneBefore = getZoneIdAt(expanded, (startUnion - 1 + span * 2) % (span * 2));
    const zoneAfter = getZoneIdAt(expanded, endUnion);

    expanded = expanded.filter(s => !((s.m_offset >= startUnion && s.m_offset <= endUnion) ||
                                     (s.m_offset >= startUnion + span && s.m_offset <= endUnion + span)));

    if (startUnion < newStartAbs || startUnion < origStart)
      expanded.push({ zone_id: zoneBefore, m_offset: startUnion });
    expanded.push({ zone_id: zid, m_offset: newStartAbs });
    expanded.push({ zone_id: zoneAfter, m_offset: newEndAbs });

    expanded.sort((a,b)=>a.m_offset-b.m_offset);
    expanded = expanded.map(s => ({ zone_id: s.zone_id, m_offset: s.m_offset % span }))
                       .sort((a,b)=>a.m_offset-b.m_offset);

    const compressed = [];
    for (const seg of expanded) {
      if (compressed.length && compressed[compressed.length-1].m_offset === seg.m_offset)
        compressed[compressed.length-1] = seg;
      else
        compressed.push(seg);
    }

    const merged = [];
    for (const seg of compressed) {
      if (!merged.length || merged[merged.length-1].zone_id !== seg.zone_id)
        merged.push(seg);
    }

    current.timetable = merged;
    normalize();
    markDirty();
    render();
  }





  function render(force_reload=false) {
    week.textContent = '';
    if (force_reload || !current) {
      const st = hass.states[sel.value];
      if(!st) { week.textContent = 'Entité introuvable'; return; }
      current = JSON.parse(JSON.stringify(st.attributes));
      current.roomMap = getRoomMap(hass);
      normalize();
      dirty = false;
      saveBtn.disabled = true;
    }

    away.value = current.away_temp ?? '';
    hg.value = current.hg_temp ?? '';
    away.onchange = ()=>{ current.away_temp = Number(away.value); markDirty(); };
    hg.onchange = ()=>{ current.hg_temp = Number(hg.value); markDirty(); };

    legend.innerHTML = current.zones.map(z =>
      `<span><i style="background:${COLORS[z.id % COLORS.length]}"></i>${z.name}</span>`
    ).join('');

    week.innerHTML = '';
    for (let d = 0; d < 7; d++) {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `<div class="lbl">${DAY[d]}</div><div class="bar"></div><button class="plusbtn" title="Ajouter créneau">+</button>`;
      const bar = row.querySelector('.bar');
      const plus = row.querySelector('.plusbtn');

      const base = d * 1440, next = base + 1440;
      const slots = current.timetable
        .filter(s => s.m_offset >= base && s.m_offset < next)
        .map(s => ({ ...s }));
      let prev = current.timetable
        .filter(s => s.m_offset < base)
        .slice(-1)[0];
      let lastZone = prev?.zone_id ?? slots[0]?.zone_id ?? 0;
      let segments = [];
      let cursor = 0;
      for (let i = 0; i < slots.length; i++) {
        let segStart = slots[i].m_offset - base;
        if (segStart > cursor) segments.push({ zone_id: lastZone, start: cursor, end: segStart });
        let segEnd = (i < slots.length - 1) ? (slots[i + 1].m_offset - base) : 1440;
        segments.push({ zone_id: slots[i].zone_id, start: segStart, end: segEnd });
        lastZone = slots[i].zone_id;
        cursor = segEnd;
      }
      if (cursor < 1440) segments.push({ zone_id: lastZone, start: cursor, end: 1440 });

      TICKS.forEach(t => {
        const tk = document.createElement('span');
        tk.className = 'tick';
        tk.style.left = `${t/14.4}%`;
        tk.textContent = fmt(t);
        bar.appendChild(tk);
      });

      segments.forEach(seg => {
        const div = document.createElement('div');
        div.className = 'seg';
        div.style.width = `${(seg.end - seg.start) / 14.4}%`;
        div.style.background = hex2rgba(COLORS[seg.zone_id % COLORS.length], 0.27);
        div.title = `${fmt(seg.start)}-${fmt(seg.end)} / ${current.zones.find(z => z.id === seg.zone_id)?.name || 'Zone ' + seg.zone_id}`;
        const absStart = seg.start + base;
        const allSlots = [...current.timetable].sort((a,b)=>a.m_offset-b.m_offset);
        const next = allSlots.find(s => s.m_offset > absStart) || allSlots[0];
        const endAbs = next.m_offset;
        const endDay = Math.floor(endAbs / 1440) % 7;
        const endTime = endAbs % 1440;
        div.onclick = () => openDialog('edit', d, { ...seg, m_offset: absStart, zone_id: seg.zone_id }, seg.start, endTime, endDay);
        bar.appendChild(div);
      });

      plus.onclick = () => {
        openDialog('insert', d, null, 0, 60, d);
      };
      week.appendChild(row);
    }

    zonesDiv.innerHTML = '';
    current.zones.forEach(z => {
      const zc = COLORS[z.id % COLORS.length];
      const box = document.createElement('div');
      box.className = 'zonebox';
      box.style.setProperty('--zone-bg', hex2rgba(zc, 0.13));
      box.innerHTML = `<h4><span class="zonecolor" style="background:${zc}"></span>${z.name}</h4>`;
      z.rooms_temp.forEach(r => {
        const div = document.createElement('div'); div.className = 'temp';
        const lab = document.createElement('span'); lab.textContent = current.roomMap[r.room_id] || r.room_id;
        const inp = document.createElement('input');
        inp.type = 'number'; inp.min = 10; inp.max = 25; inp.step = 0.5; inp.value = r.temp;
        inp.onchange = e => { r.temp = +e.target.value; markDirty(); };
        const plus = document.createElement('button'); plus.type = 'button'; plus.textContent = '+'; plus.onclick = () => { inp.value = (+inp.value + 0.5).toFixed(1); inp.onchange({target:inp}); };
        const minus = document.createElement('button'); minus.type = 'button'; minus.textContent = '–'; minus.onclick = () => { inp.value = (+inp.value - 0.5).toFixed(1); inp.onchange({target:inp}); };
        div.append(lab, minus, inp, plus);
        box.appendChild(div);
      });
      zonesDiv.appendChild(box);
    });
  }

  function openDialog(mode, day, slot, start, end, endDay = day) {
    dZone.innerHTML = '';
    current.zones.forEach(z => {
      const o = document.createElement('option');
      o.value = z.id;
      o.textContent = z.name;
      dZone.appendChild(o);
    });
    dEndDay.innerHTML = '';
    DAY.forEach((name, i) => {
      const o = document.createElement('option');
      o.value = i;
      o.textContent = name;
      dEndDay.appendChild(o);
    });
    dStart.value = fmt(start);
    dEnd.value = fmt(end);
    dEndDay.value = endDay;
    dZone.value = slot?.zone_id ?? current.zones[0]?.id ?? 0;
    editing = { mode, slot, day, orig_start: start, orig_end: end, orig_end_day: endDay };
    dlgTitle.textContent = mode === "edit" ? "Éditer créneau" : "Ajouter créneau";
    dlg.showModal();
  }

  dlg.addEventListener('close', () => {
    if(dlg.returnValue !== 'default') return;

    const [sh, sm] = dStart.value.split(':').map(Number);
    const [eh, em] = dEnd.value.split(':').map(Number);
    const zid = +dZone.value;
    const endDay = +dEndDay.value;
    const day = editing.day;
    let ns = sh * 60 + sm;
    let ne = eh * 60 + em;
    if (ne === 0) ne = 1440;

    if(editing.mode === 'insert') {
      insertSlot(day, endDay, ns, ne, zid);
    } else if(editing.mode === 'edit') {
      // Pour l'édition, on cherche l'offset d'origine pour bien couper proprement
      const orig_start = editing.slot.start;
      const orig_end   = editing.slot.end;
      const orig_end_day = editing.orig_end_day;
      editSlot(day, orig_start, orig_end_day, orig_end, ns, endDay, ne, zid);
    }
  });

  sel.onchange = function() {
    week.textContent = 'Chargement…';
    setTimeout(()=>render(true), 100);
  };

  saveBtn.onclick = async () => {
    if (!dirty) return;
    await hass.callService('mqtt', 'publish', {
      topic: `plannings/${sel.value.split('.')[1]}/set`,
      payload: JSON.stringify({
        timetable: current.timetable,
        zones: current.zones,
        away_temp: current.away_temp,
        hg_temp: current.hg_temp
      }),
      retain: true
    });
    dirty = false; saveBtn.disabled = true;
    alert('MQTT envoyé');
    setTimeout(()=>render(true), 900);
    location.reload();
  };

  render(true);
})();
</script>
</body>
</html>
